


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        [РЕШЕНО] Виртуальная флешка
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/posts/" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/topics/" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="/">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="/news/">Новости</a></li>
    <li class="active"><a href="/forum/">Форум</a></li>
    <li class=""><a href="/blogs/">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_%28%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9%29">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="/irc/#chat">IRC</a></li>
      <li class="dropdown">
        <a href="/accounts/login/" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="/accounts/login/">Вход</a></li>
          <li><a href="/accounts/register/">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="/messages/inbox/" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="/">ArchLinux.org.ru</a></li>


    <li><a href="/forum/">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="/forum/category/2/">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="/forum/forum/12/">Ядро и Железо</a> <span class="divider">/</span></li>
            
        
        
            <li>[РЕШЕНО] Виртуальная флешка</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>[РЕШЕНО] Виртуальная флешка</h1>
        
            <div class="text-center">
    


    <nav>
        <ul class="pagination">
            
                <li class="previous">
                    <a href="?page=2" aria-label="предыдущая страница">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="hidden-xs">предыдущая страница</span>
                    </a>
                </li>
            

            
                
                    
                        <li>
                            <a href="?page=1">1</a>
                        </li>
                    
                
            
                
                    
                        <li>
                            <a href="?page=2">2</a>
                        </li>
                    
                
            
                
                    
                        <li class="active">
                            <a href="?page=3">3 <span class="sr-only">(текущая страница)</span></a>
                        </li>
                    
                
            

            
                <li class="next disabled">
                    <span>
                        <span class="hidden-xs">следующая страница</span>
                        <span aria-hidden="true">&raquo;</span>
                    </span>
                </li>
            
        </ul>
    </nav>


</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-194237"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/vasek/">
                <span class="post-username">vasek</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/194237/">#</a>
            5 лет назад
            
                (отредактировано
                
                    5 лет назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/vasek/topics/">
                    48
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/vasek/posts/">
                    11340
                </a>
            </div>
            <div>
                Участник с: 17 февраля 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Bill_Williamson</em><br>Собрал ядро пока на arch в виртуальной машине по этой инструкций в вики, предварительно отредактировав через menuconfig как требовалось тут.</blockquote>Решил попробовать, но make menuconfig раскоментировал в PKGBUILD, т. е. предварительно ничего не готовил ……. и был удивлен, когда открылась картинка, выглядело немного по другому ……. а когда скомпилировал и установил, то модуля <strong>g_mass_storage</strong> в системе не оказалось, но появился модуль  <strong>libcomposite</strong> — хотел перекомпилить по-новой, отдельно заготовив config, но отказался (ноут пахал 1,5 часа и темпереатура держалась в пределах 80-83 градуса).<br />Стал разбираться с установленным — <u>все оказалось не так то просто</u>, посмотри, например, <a href="https://www.mjmwired.net/kernel/Documentation/usb/gadget_configfs.txt">это</a>. В итоге плюнул и забросил — всеравно не вижу для себя причин для использования.<br />PS ... а вот почему не оказалось модуля g_mass_storage, так и не понял, то ли сам при настройке дал маху, то ли нужно config готовить отдельно и подсовывать вместо скаченного, но, для повторения операций, как писал, жалко ноут (пашут 4 потока и 1,5 часа + высокая температура - все таки для таких задач нужна машинка помощнее)
            
                
                    <div class="post-signature">
                        Ошибки не исчезают с опытом - они просто умнеют
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-194238"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/jim945/">
                <span class="post-username">jim945</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/194238/">#</a>
            5 лет назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/f7/09/f709d8f74afad03709f159a1e12444ef.png" alt="jim945 avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/jim945/topics/">
                    8
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/jim945/posts/">
                    3066
                </a>
            </div>
            <div>
                Участник с: 25 января 2010
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Bill_Williamson</em><br>Т.е. qemu умеет распознавать файл флешкой?</blockquote>Если судить по тому что написано в man<br /><pre><code>       -usb
           Enable the USB driver (will be the default soon)

       -usbdevice devname
           Add the USB device devname.

...

           disk:[format=format]:file
               Mass storage device based on file. The optional format argument will be used rather than detecting the format. Can be used to specify &quot;format=raw&quot; to avoid interpreting an untrusted format header.</code></pre>
            
                
                    <div class="post-signature">
                        Lupus pilum mutat, non mentem.
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-194246"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/vasek/">
                <span class="post-username">vasek</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/194246/">#</a>
            5 лет назад
            
                (отредактировано
                
                    5 лет назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/vasek/topics/">
                    48
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/vasek/posts/">
                    11340
                </a>
            </div>
            <div>
                Участник с: 17 февраля 2013
            </div>
            
        </td>
        <td class="post-content">
            Любопытство пересилило и все-таки решился разобраться с этой виртуальной флешкой (пришлось еще раз помучать ноутбук).<br />Создал отдельно свой config и заменил им config.x86_64 — подключил следующие модули<br />CONFIG_USB_GADGET=m<br />CONFIG_USB_GADGETFS=m<br />CONFIG_USB_DUMMY_HCD=m<br />Модуль <strong>dummy_hcd</strong> обязателен<br /><pre><code>This host controller driver emulates USB, looping all data transfer requests back to a USB &quot;gadget driver&quot; in the same host. The host side is the master; the gadget side is the slave. Gadget drivers can be high, full, or low speed; and they have access to endpoints like those from NET2280, PXA2xx, or SA1100 hardware.
This may help in some stages of creating a driver to embed in a Linux device, since it lets you debug several parts of the gadget driver without its hardware or drivers being involved.
Since such a gadget side driver needs to interoperate with a host side Linux-USB device driver, this may help to debug both sides of a USB protocol stack.
Say &quot;y&quot; to link the driver statically, or &quot;m&quot; to build a dynamically linked module called &quot;dummy_hcd&quot; and force all gadget drivers to also be dynamically linked.</code></pre>После загрузки модуля  dummy_hcd в выводе lsusb -t появилась новая строчка<br />/:  Bus 05.Port 1: Dev 1, Class=root_hub, <strong>Driver=dummy_hcd</strong>/1p, 480M<br />Все, дальше можно эмулировать как готовый образ флэшки, так и создать новый файл (но его нужно отформатировать и создать разделы, вообщем все как с обычной флешкой).<br />Был образ загрузочной флешки 1G (спецсофт для экстренных нужд), после его эмуляции  получилась обычная флешка — видна в файл-менеджере, lsblk и fdisk<br />Вывод # <strong>fdisk -l /dev/sdb</strong><br /><pre><code>Устр-во    Загрузочный начало   Конец Секторы Размер Идентификатор Тип
/dev/sdb1  *               63 2019999 2019937 986,3M             7 HPFS/NTFS/exFAT</code></pre><br />PS ... доступны следующие модули (для эмуляции)<br /> <pre><code>Gadget Zero (DEVELOPMENT)
 Audio Gadget
 Ethernet Gadget (with CDC Ethernet support)
 Network Control Model (NCM) support
 Gadget Filesystem
 Function Filesystem
 Mass Storage Gadget
 Serial Gadget (with CDC ACM and CDC OBEX support)
 MIDI Gadget
 Printer Gadget
 CDC Composite Device (Ethernet and ACM)
 CDC Composite Device (ACM and mass storage)
 Multifunction Composite Gadget
 HID Gadget
 EHCI Debug Device Gadget
 USB Webcam Gadget</code></pre>
            
                
                    <div class="post-signature">
                        Ошибки не исчезают с опытом - они просто умнеют
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-194309"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/vasek/">
                <span class="post-username">vasek</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/194309/">#</a>
            5 лет назад
            
                (отредактировано
                
                    5 лет назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/vasek/topics/">
                    48
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/vasek/posts/">
                    11340
                </a>
            </div>
            <div>
                Участник с: 17 февраля 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Bill_Williamson</em><br>И как добиться добавления этого модуля при каждом обновлений ядра, через dkms?</blockquote>Мы с <strong>nafanja</strong> ответили, что DKMS будет трудновато.<br />Хочу уточнить - собрать и установить нужные модули можно и без пересборки ядра - займет времени не больше часа, а , главное, эти модули при обновлении ядра можно опять подсунуть и это частенько срабатывает, правда не всегда. Ну а если не сработает, то опять можно пересобрать, а для облегчения можно написать и скрипт сборки модулей.<br /><br />EDIT1 .... <strong>не прав</strong>, данные модули зависят от версии ядра. Собрал все модули на имеющихся исходниках linux-4.11.2 - modinfo понимает нормально, конечно, vermagik не совпадает и модуль не загружается.
            
                
                    <div class="post-signature">
                        Ошибки не исчезают с опытом - они просто умнеют
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    


    <nav>
        <ul class="pagination">
            
                <li class="previous">
                    <a href="?page=2" aria-label="предыдущая страница">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="hidden-xs">предыдущая страница</span>
                    </a>
                </li>
            

            
                
                    
                        <li>
                            <a href="?page=1">1</a>
                        </li>
                    
                
            
                
                    
                        <li>
                            <a href="?page=2">2</a>
                        </li>
                    
                
            
                
                    
                        <li class="active">
                            <a href="?page=3">3 <span class="sr-only">(текущая страница)</span></a>
                        </li>
                    
                
            

            
                <li class="next disabled">
                    <span>
                        <span class="hidden-xs">следующая страница</span>
                        <span aria-hidden="true">&raquo;</span>
                    </span>
                </li>
            
        </ul>
    </nav>


</div>

        

        

        
            
<a href="/accounts/register/">Зарегистрироваться</a> или <a href="/accounts/login/?next=/forum/topic/17761/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script>(function(){var js = "window['__CF$cv$params']={r:'747b8415bc549db7',m:'FKesf1G9_EuLy9lJJdLt9so9APYlzaRyn0WUGKWLhco-1662680288-0-ARrCPq2rZWQoBVNSgiCp/vgJNxFNrwxgI1f95f+gquo3QTtvZ+MSG5/8A6g/OjDrRQTftxQZf51tSPY/GehJRqpZFWDUm2JM0Q0D1WQIeg0uoJ+qVA/PMpJWz0V4B7BZWDoP18ZQXJa9/UEVOkWdb1o=',s:[0x65321c872b,0x5187650b94],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='/cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
</html>
