


<!DOCTYPE html>
<html lang="ru">

<!-- Mirrored from archlinux.org.ru/forum/topic/20319/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 08 Sep 2022 07:52:42 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        systemd-nspawn, alsa и Loopback Mixer
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://archlinuxcomru.github.io/backup/src/css/bootstrap.css">
    
    
    

    <script type="text/javascript" src="https://archlinuxcomru.github.io/backup/src/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://archlinuxcomru.github.io/backup/src/js/bootstrap.js"></script>
    <script type="text/javascript" src="https://archlinuxcomru.github.io/backup/src/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="../../feeds/posts/index.html" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="../../feeds/topics/index.html" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="../../../index.html">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="../../../news/index.html">Новости</a></li>
    <li class="active"><a href="../../index.html">Форум</a></li>
    <li class=""><a href="../../../blogs/index.html">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_(Русский)">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="../../../irc/index.html#chat">IRC</a></li>
      <li class="dropdown">
        <a href="../../../accounts/login/index.html" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="../../../accounts/login/index.html">Вход</a></li>
          <li><a href="../../../accounts/register/index.html">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="../../../messages/inbox/index.html" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="../../../index.html">ArchLinux.org.ru</a></li>


    <li><a href="../../index.html">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="../../category/2/index.html">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="../../forum/9/index.html">Новичкам в Arch Linux</a> <span class="divider">/</span></li>
            
        
        
            <li>systemd-nspawn, alsa и Loopback Mixer</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>systemd-nspawn, alsa и Loopback Mixer</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-236805"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/frankyboy/index.html">
                <span class="post-username">frankyboy</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/236805/index.html">#</a>
            1 год, 10 месяцев назад
            
                (отредактировано
                
                    1 год, 10 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/14/a1/14a15e09e2df2e1b4a01866cfd4b3242.png" alt="frankyboy avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/frankyboy/topics/index.html">
                    15
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/frankyboy/posts/index.html">
                    324
                </a>
            </div>
            <div>
                Участник с: 05 декабря 2012
            </div>
            
        </td>
        <td class="post-content">
            Всех приветствую.<br /><br />зашёл в тупик по такому вопросу:<br />1. имеется контейнер, который запускается посредством команды: <pre><code>systemd-nspawn -bD steamcontainer -M &quot;steamcontainer&quot; \
--volatile=no \
--bind=/dev/shm \
--bind=/dev/snd \
--bind=/dev/dri \
--bind=/dev/kvm \
--bind=/dev/input \
--bind-ro=/tmp/.X11-unix:/tmp/.X11-unix \
--property=&quot;DeviceAllow=/dev/dri rw&quot; \
--property=&quot;DeviceAllow=/dev/shm rw&quot; \
--property=&quot;DeviceAllow=/dev/kvm rw&quot; \
--property=&quot;DeviceAllow=/dev/input rw&quot; \
--property=&quot;DeviceAllow=/dev/dri/renderD128 rw&quot; \
--property=&quot;DeviceAllow=char-usb_device rwm&quot; \
--property=&quot;DeviceAllow=char-input rwm&quot; \
--property=&quot;DeviceAllow=char-alsa rwm&quot; \
--property=&quot;DeviceAllow=char-drm rwm&quot;</code></pre>2. доступ устройств к контейнеру осуществялется через команду выше и через <pre><code>xhost +local:</code></pre>3. Имеется виртуальная звуковая карта, настроенная через альсу, позволяющая выводить звук одновременно в несколько приложений: <pre><code>**** List of PLAYBACK Hardware Devices ****
card 0: Loopback [Loopback], device 0: Loopback PCM [Loopback PCM]
  Subdevices: 7/8
  Subdevice #0: subdevice #0
  Subdevice #1: subdevice #1
  Subdevice #2: subdevice #2
  Subdevice #3: subdevice #3
  Subdevice #4: subdevice #4
  Subdevice #5: subdevice #5
  Subdevice #6: subdevice #6
  Subdevice #7: subdevice #7
card 0: Loopback [Loopback], device 1: Loopback PCM [Loopback PCM]
  Subdevices: 8/8
  Subdevice #0: subdevice #0
  Subdevice #1: subdevice #1
  Subdevice #2: subdevice #2
  Subdevice #3: subdevice #3
  Subdevice #4: subdevice #4
  Subdevice #5: subdevice #5
  Subdevice #6: subdevice #6
  Subdevice #7: subdevice #7
card 1: HDMI [HDA ATI HDMI], device 3: HDMI 0 [HDMI 0]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: HDMI [HDA ATI HDMI], device 7: HDMI 1 [HDMI 1]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: HDMI [HDA ATI HDMI], device 8: HDMI 2 [HDMI 2]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: HDMI [HDA ATI HDMI], device 9: HDMI 3 [HDMI 3]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: HDMI [HDA ATI HDMI], device 10: HDMI 4 [HDMI 4]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 1: HDMI [HDA ATI HDMI], device 11: HDMI 5 [HDMI 5]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
card 2: Generic [HD-Audio Generic], device 0: ALC1220 Analog [ALC1220 Analog]
  Subdevices: 0/1
  Subdevice #0: subdevice #0
card 2: Generic [HD-Audio Generic], device 1: ALC1220 Digital [ALC1220 Digital]
  Subdevices: 1/1
  Subdevice #0: subdevice #0</code></pre>4. контейнер звук проигрывает, но только когда звуковая карта не занята другими приложениями, иначе следует ошибка: <pre><code>Playback device is hw:Loopback,0,0
Stream parameters are 48000Hz, S16_LE, 2 channels
Using 16 octaves of pink noise
Playback open error: -16,Device or resource busy</code></pre>5. asoundrc <pre><code>defaults.pcm.card 0
defaults.ctl.card 0
defaults.pcm.dmix.!rate 96000
defaults.pcm.dmix.!format S16_LE
defaults.pcm.rate_converter &quot;speexrate_best&quot;

pcm.!default {
  type asym
  playback.pcm &quot;LoopAndReal&quot;
  #capture.pcm &quot;looprec&quot;
  capture.pcm &quot;MixLoopback&quot; #hw:0,1
}

pcm.looprec {
    type hw
    card &quot;Loopback&quot;
    device 0
    subdevice 1
}
pcm.LoopAndReal {
  type plug
  slave.pcm mdev
  route_policy &quot;duplicate&quot;
}
pcm.mdev {
  type multi
  slaves.a.pcm pcm.MixReale
  slaves.a.channels 2
  slaves.b.pcm pcm.MixLoopback
  slaves.b.channels 2
  bindings.0.slave a
  bindings.0.channel 0
  bindings.1.slave a
  bindings.1.channel 1
  bindings.2.slave b
  bindings.2.channel 0
  bindings.3.slave b
  bindings.3.channel 1
}
pcm.MixReale {
  type dmix
  ipc_key_add_uid true
  ipc_perm 0666
  ipc_key 1024
  slave {
    pcm &quot;hw:2,0&quot;
    rate 96000
    #rate 48000
    #rate 44100
    periods 128
    period_time 0
    period_size 1024 # must be power of 2
    buffer_size 8192
  }
}

pcm.MixLoopback {
  type dmix
  ipc_key_add_uid true
  ipc_perm 0666
  ipc_key 1025
  slave {
    pcm &quot;hw:Loopback,0,0&quot;
    rate 96000
    #rate 48000
    periods 128
    period_time 0
    period_size 1024 # must be power of 2
    buffer_size 131072
  }
}
# Multi, splitting onto usual card and loopback
pcm.out {
    type plug
    slave.pcm {
        type multi
        slaves {
            a { channels 2 pcm &quot;dmix:MixReale&quot; }
            b { channels 2 pcm &quot;dmix:MixLoopback&quot; }
        }
        bindings {
            0 { slave a channel 0 }
            1 { slave a channel 1 }
            2 { slave b channel 0 }
            3 { slave b channel 1 }
        }
    }
    ttable [
        [ 1 0 1 0 ]   # left  -&gt; a.left,  b.left
        [ 0 1 0 1 ]   # right -&gt; a.right, b.right
    ]
}

defaults.pcm.surround21.card off
defaults.pcm.surround21.device off
defaults.pcm.surround40.card off
defaults.pcm.surround40.device off
defaults.pcm.surround41.card off
defaults.pcm.surround41.device off
defaults.pcm.surround50.card off
defaults.pcm.surround50.device off
defaults.pcm.surround51.card off
defaults.pcm.surround51.device off
defaults.pcm.surround71.card off
defaults.pcm.surround71.device off</code></pre><br />прошу помочь советом есть ли возможность заставить звук работать в контейнере?
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-236814"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/vasek/index.html">
                <span class="post-username">vasek</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/236814/index.html">#</a>
            1 год, 10 месяцев назад
            
                (отредактировано
                
                    1 год, 10 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/vasek/topics/index.html">
                    48
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/vasek/posts/index.html">
                    11320
                </a>
            </div>
            <div>
                Участник с: 17 февраля 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>frankyboy</em><br>есть ли возможность заставить звук работать в контейнере?</blockquote>Очень много нюансов, в том числе и что это за контейнер.<br />Основное назначение systemd_nspawn - <u>это отладка, восстановление системы вместо chroot</u> - просто это намного удобнее и проще (для перехода в контейнер нужно запустить всего 2 команды) и больше возможностей. В остальных случаях лично по мне так это лишнее …<br />Сам использовал systemd_nspawn несколько раз и даже выполнял обновление/замену пакетов - удобно тем, что работает интернет, можешь отрыть/посмотреть любой документ, подключить любое нужное устройство … так как все это выполняется из нормальной работающей системы, а контейнер с аварийной системой занимает при этом только один терминал-эмулятор - то есть в любой момент можешь переключиться из этого терминала в другое окно ...<br />Но вот с подключением устройств и изменением интерфейсов в самом контейнере не все так просто<br /><pre><code>systemd-nspawn limits access to various kernel interfaces in the container to read-only, such as /sys, /proc/sys or /sys/fs/selinux. Network interfaces and the system clock may not be changed from within the container. Device nodes may not be created. The host system cannot be rebooted and kernel modules may not be loaded from within the container.</code></pre>Как пример, имею USB 3g Modem, вывод lsusb одинаков и в системе и в контейнере<br />lsusb<br /><pre><code>Bus 003 Device 002: ID 12d1:1506 Huawei Technologies Co., Ltd. Modem/Networkcard</code></pre>В системе все нормально<br /><strong>file /dev/bus/usb/003/002</strong><br /><pre><code>/dev/bus/usb/003/002: character special (189/257)</code></pre>А вот в контейнере проблемы<br /><strong>file /dev/bus/usb/003/002</strong><br /><pre><code>/dev/bus/usb/003/002: cannot open `/dev/bus/usb/003/002&#39; (No such file or directory)</code></pre>Смотрим модуль<br /><strong>lsmod | grep usbserial</strong><br />… пусто …<br />пробуем загрузить<br /><strong>modprobe -v usbserial</strong><br /><pre><code>modprobe: FATAL: Module usbserial not found in directory /lib/modules/5.8.1-arch1-1</code></pre>… и понятно, что не загрузим …<br />Но я не стал и разбираться, просто это мне и не нужно, так как если подключаю модем в самой системе, то сеть имеется и в контейнере и можно спокойно обновиться<br /><strong>root #  pacman -Syu</strong><br />:: Обновление баз данных пакетов…<br /><pre><code>Пакеты (10) dhcpcd-9.3.2-1  go-2:1.15.4-1  imagemagick-7.0.10.37-1  lib32-libldap-2.4.54-1
            linux-5.9.6.arch1-1  linux-headers-5.9.6.arch1-1  linux-lts-5.4.75-1
            linux-lts-headers-5.4.75-1  sysstat-12.4.0-2  zbar-0.23.1-3
…………..
==&gt; finished: 10 packages removed (disk space saved: 316.05 MiB)</code></pre>обновились, смотрим какое ядро стало в контейнере<br /><strong>root # ls /usr/lib/modules</strong><br />5.4.75-1-lts  5.9.6-arch1-1<br />… то есть обновилось до linux-5.9.6.arch1-1 … но в тоже время в самой системе, А НЕ SYSTEMD_NSPAWN имеем<br /><strong>root #  uname -r</strong><br />5.8.1-arch1-1<br /><br />Кроме этого есть еще и нюансы с разрешением доступа к устройствам в случае если вывод   <strong>file /dev/bus/usb/00N/00M</strong>  нормальный
            
                
                    <div class="post-signature">
                        Ошибки не исчезают с опытом - они просто умнеют
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-236939"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/frankyboy/index.html">
                <span class="post-username">frankyboy</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/236939/index.html">#</a>
            1 год, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/14/a1/14a15e09e2df2e1b4a01866cfd4b3242.png" alt="frankyboy avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/frankyboy/topics/index.html">
                    15
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/frankyboy/posts/index.html">
                    324
                </a>
            </div>
            <div>
                Участник с: 05 декабря 2012
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>vasek</em><br>root # ls /usr/lib/modules<br />5.4.75-1-lts 5.9.6-arch1-1</blockquote>на данный момент, единственное, что могу заметить, так это то, что в контейнере у меня пакет линукс не установлен.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-236955"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/vasek/index.html">
                <span class="post-username">vasek</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/236955/index.html">#</a>
            1 год, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/vasek/topics/index.html">
                    48
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/vasek/posts/index.html">
                    11320
                </a>
            </div>
            <div>
                Участник с: 17 февраля 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>frankyboy</em><br>единственное, что могу заметить, так это то, что в контейнере у меня пакет линукс не установлен.</blockquote>Опишу немного, как я использую этот <strong>systemd-nspawn</strong><br />Потратил как то часть времени на изучение этого systemd-nspawn, подумал, подумал как его применить, но ничего в голову не пришло, кроме одного - восстановление системы … вместо chroot. Нюансов с использованием этого systemd-nspawn возникает много, но это связано с тем, что глубоко не копаем и многие положения не совсем понимаем.<br />А вот в части использования вместо chroot мне понравилось, одно НО - нужна 2-ая система Linux, которая у меня всегда стоит (клон рабочей системы). Конечно, кто не экспериментирует с системой, это ему в принципе и не нужно. Мне же, хоть и не часто, но требуется.<br />Какие удобства?<br />- находишься в рабочей системе Linux - под рукой любые документы с нужной информацией, список команд, при необходимости можно и погуглить<br />- наличие интернета в рабочей системе можно использовать и в контейнере, то есть имеется возможность сделать обновление, установку нужных пакетов<br />- полный доступ ко всем файлам в контейнере<br />- простота запуска контейнера, всего две команды: 1-ая - монтирование нужного контейнера/системы, 2-ая - запуск<br />Контейнером у меня является или рабочая система или ее клон, настроен запуск контейнера/системы в rescue mode - большего мне и не нужно.<br /><br />Конечно, кому то покажется это не разумным и громозким, но у меня правило - всегда иметь 2-ую систему Linux - вместо Live CD/USB - а с недавнего времени в качестве 2-ой системой стал использовать клон рабочей системы (клон обновляется редко) … это еще и удобно тем, что по-существу это backup системы, но вполне рабочий … а потому в данном случае мне и удобнее использовать  systemd-nspawn вместо chroot, вот только пока не пойму - полноценная ли это замена chroot? не ли каких-либо темных нюансов.
            
                
                    <div class="post-signature">
                        Ошибки не исчезают с опытом - они просто умнеют
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="../../../accounts/register/index.html">Зарегистрироваться</a> или <a href="../../../accounts/login/index7c14.html?next=/forum/topic/20319/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

</body>

<!-- Mirrored from archlinux.org.ru/forum/topic/20319/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 08 Sep 2022 07:52:42 GMT -->
</html>
