


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Проблемы со squid
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/posts/" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/topics/" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="/">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="/news/">Новости</a></li>
    <li class="active"><a href="/forum/">Форум</a></li>
    <li class=""><a href="/blogs/">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_%28%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9%29">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="/irc/#chat">IRC</a></li>
      <li class="dropdown">
        <a href="/accounts/login/" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="/accounts/login/">Вход</a></li>
          <li><a href="/accounts/register/">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="/messages/inbox/" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="/">ArchLinux.org.ru</a></li>


    <li><a href="/forum/">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="/forum/category/2/">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="/forum/forum/13/">Сети, Серверы, Защита</a> <span class="divider">/</span></li>
            
        
        
            <li>Проблемы со squid</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>Проблемы со squid</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-29713"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/kirillpsl/">
                <span class="post-username">kirillpsl</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/29713/">#</a>
            10 лет, 7 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/kirillpsl/topics/">
                    20
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/kirillpsl/posts/">
                    79
                </a>
            </div>
            <div>
                Участник с: 12 октября 2009
            </div>
            
        </td>
        <td class="post-content">
            Squid иногда начал ругаться : <br/><br/><div class="code"><pre>При получении URL <a href="https://www.avito.ru/">http://www.avito.ru/</a> произошла следующая ошибка
    Соединение с 80.76.156.73 не удалось
Система вернула: (111) Connection refused
Удаленный узел или сеть недоступен. Повторите запрос позднее
Администратор Вашего кэша: <a href="/cdn-cgi/l/email-protection#b3c1dcdcc7f3cbcbcbcb9dc1c69dcbdd9e9e8f9cc3c1d68d8f9cd7dac58d8fd1c19c8d9e8b87dd84d784d4c7d284de"><span class="__cf_email__" data-cfemail="e4968b8b90a49c9c9c9cca9691ca">[email&#160;protected]</span></pre></div><br/>Думал</a> что проблемы в конфиге, с дефолтным тоже самое, сейчас в конфиге : <br/><br/><div class="code"><pre>#squid.conf
##Перечитать настройки без перезапуска демона: 'squid -k reconfigure' (очевидно, не самые критичные)
http_port 3128 transparent
#acl all src 0.0.0.0/0 пришлось отключить после апдейта сквида, видимо эт. уже дефолт
acl localhost src 127.0.0.1/32
acl localNet src 192.168.1.2-192.168.1.254
acl SSL_ports port 443 563
acl Safe_ports port 80 # http
acl Safe_ports port 21 # ftp
acl Safe_ports port 443 563 # https
acl Safe_ports port 70 # gopher
acl Safe_ports port 210 # wais
acl Safe_ports port 1025-65535 # unregistered ports
acl Safe_ports port 280 # http-mgmt
acl Safe_ports port 488 # gss-http
acl Safe_ports port 591 # filemaker
acl Safe_ports port 777 # multiling http
acl CONNECT method CONNECT
acl Rsync_ports port 873
acl Jabber_ports port 5222 5223
acl Safe_ports port 631
acl Safe_ports port 901
#acl black_list dstdomain .vk.com .vkontakte.ru
#acl not_black-list src 192.168.1.77 192.168.1.84 192.168.1.16
#acl Site dst <a href="https://www.avito.ru">www.avito.ru</a>
acl Web_ports port 80
http_access deny !Web_ports !SSL_ports !Safe_ports !Rsync_ports !Jabber_ports
#http_access_allow Site
http_access allow localhost
http_access allow localNet
http_access deny all
#CACHE OPTIONS
cache_mem 64 MB
cache_swap_high 95
cache_swap_low 90
maximum_object_size 4896 KB
minimum_object_size 0 KB
memory_pools off        #высвобождение в систему захваченной, но не нужно памяти
quick_abort_pct 97      #если скачано 97% и юзер отменил - докачать (в кэш)
negative_ttl 1 minutes  #кэширование "негативных ответов", типа 404, время жизни в кэше
# OPTIONS WHICH AFFECT THE NEIGHBOR SELECTION ALGORITHM
hierarchy_stoplist cgi-bin ?
acl QUERY urlpath_regex cgi-bin \?
no_cache deny QUERY
#Suggested default:
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
# Leave coredumps in the first cache dir
coredump_dir /var/cache/squid
#LOGFILE OPTIONS
access_log /var/log/squid/access.log squid
#OTHER_FOR_ERROR_REPORTS
error_directory /usr/share/squid/errors/ru
httpd_suppress_version_string on #Подавлять вывод версии
visible_hostname proxy251
cache_mgr <a href="/cdn-cgi/l/email-protection#49282d2420276422203b202525092b3f2a24673b3c"><span class="__cf_email__" data-cfemail="3c5d585155521157554e5550507c5e4a5f51124e49">[email&#160;protected]</span></a>
dns_nameservers 8.8.8.8 213.189.240.24 #Гугловский и от провайдера</pre></div><br/>Решил кеш пересоздать, при создание в логи пишутся варнинги типа :<br/><div class="code"><pre>2012/01/13 12:43:35| WARNING: Forwarding loop detected for:
GET / HTTP/1.1
User-Agent: Wget/1.10+devel
Accept: */*!
Host: 213.189.250.95:3128
Via: 1.0 proxy251 (squid), 1.1 proxy251 (squid)
X-Forwarded-For: 199.192.156.211, 213.189.250.95
Cache-Control: max-age=259200
Connection: keep-alive
2012/01/13 12:43:35| WARNING: Forwarding loop detected for:
GET / HTTP/1.1
User-Agent: Wget/1.10+devel
Accept: */*!
Host: 213.189.250.95:3128
Via: 1.0 proxy251 (squid), 1.1 proxy251 (squid), 1.1 proxy251 (squid)
X-Forwarded-For: 199.192.156.211, 213.189.250.95, 213.189.250.95
Cache-Control: max-age=259200
Connection: keep-alive
2012/01/13 12:43:35| WARNING: Forwarding loop detected for:
GET / HTTP/1.1
User-Agent: Wget/1.10+devel
Accept: */*!
Host: 213.189.250.95:3128
Via: 1.0 proxy251 (squid), 1.1 proxy251 (squid), 1.1 proxy251 (squid), 1.1 proxy251 (squid)
X-Forwarded-For: 199.192.156.211, 213.189.250.95, 213.189.250.95, 213.189.250.95
Cache-Control: max-age=259200
Connection: keep-alive</pre></div>Причем много таких варнингов, не пойму в чем дело&#8230; Каждый следующий варнинг добавляет 213.189.250.95, ++ =))<br/><br/>Работает все нормально, за исключение некоторых сайтов&#8230;<br/><br/><div class="code"><pre>[<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c0b0b3ac80b0b2afb8b9f2f5f1">[email&#160;protected]</a> ~]$ sudo iptables -L -t nat
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
SNAT       all  --  it02        anywhere             to:213.189.250.95
ACCEPT     all  --  anywhere             anywhere            
           all  --  anywhere             anywhere  </pre></div><br/>ifconfig : <br/><div class="code"><pre>[<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bececdd2fececcd1c6c78c8b8f">[email&#160;protected]</a> ~]$ ifconfig 
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500  metric 1
        inet 192.168.1.251  netmask 255.255.255.0  broadcast 192.168.255.255
        inet6 fe80::16da:e9ff:feb6:392b  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 14:da:e9:b6:39:2b  txqueuelen 1000  (Ethernet)
        RX packets 381643  bytes 69936688 (66.6 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 400108  bytes 410876682 (391.8 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 1  collisions 0
        device interrupt 54  
eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500  metric 1
        inet 213.189.250.95  netmask 255.255.255.0  broadcast 213.189.250.255
        inet6 fe80::1e7e:e5ff:fe26:4264  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 1c:7e:e5:26:42:64  txqueuelen 1000  (Ethernet)
        RX packets 6701337  bytes 1588992909 (1.4 GiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 7043464  bytes 3044583540 (2.8 GiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        device interrupt 19  base 0xa000  
lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 16436  metric 1
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 0  (Local Loopback)
        RX packets 46147  bytes 47509566 (45.3 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 46147  bytes 47509566 (45.3 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</pre></div><br/>resolv.conf - но в скивиде прописал отдельно DNSки<br/><div class="code"><pre>#
# /etc/resolv.conf
#
search udvcm
domain ubvcm
nameserver 192.168.1.2
nameserver 213.189.240.24
#search &lt;yourdomain.tld&gt;
#nameserver &lt;ip&gt;
# End of file</pre></div><br/>Прописал ip avito.ru в dns, т.е. и в конфиг сквида и в resolf.conf всеравно не пускает сквид
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-29714"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/sleepycat/">
                <span class="post-username">sleepycat</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/29714/">#</a>
            10 лет, 7 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/f2/c0/f2c02cdf7ab1395c1ebcd403ff0c9d53.png" alt="sleepycat avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/sleepycat/topics/">
                    98
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/sleepycat/posts/">
                    3291
                </a>
            </div>
            <div>
                Участник с: 19 июля 2011
            </div>
            
        </td>
        <td class="post-content">
            со временем не рассосалась? Просто намедни ко мне поступали вопросы про недоступность этого хоста (3 яеловека в 24 часа), заподозрил глюки или работы на сервере, но вроде прошло&#8230;может не сквид?
            
                
                    <div class="post-signature">
                        Лозунг у них был такой: &quot;Познание бесконечности требует бесконечного времени&quot;. С этим я не спорил, но они делали из этого неожиданный вывод: &quot;А потому работай не работай — все едино&quot;. И в интересах неувеличения энтропии Вселенной они не работали. (с)
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-29715"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/kirillpsl/">
                <span class="post-username">kirillpsl</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/29715/">#</a>
            10 лет, 7 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/kirillpsl/topics/">
                    20
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/kirillpsl/posts/">
                    79
                </a>
            </div>
            <div>
                Участник с: 12 октября 2009
            </div>
            
        </td>
        <td class="post-content">
            низнаю ваще&#8230; вот все уже перепроверил, пока только один сайт мозги парит&#8230; дальше будет видно<br/><br/>проблема так и осталась! Причем мной замечен только один сайт! Авита!<br/><br/>проблема осталась&#8230; как быть не знаю как быть
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="/accounts/register/">Зарегистрироваться</a> или <a href="/accounts/login/?next=/forum/topic/2856/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){var js = "window['__CF$cv$params']={r:'747c4dc35cb11607',m:'Zuy4C2HzoQ1HE2m8XUdh1FrTTituEsTj4spbtvJQKJ8-1662688548-0-AdKl4zyk10FT9Xj5T4xCU1U4BRgYnvVwvwzpaniVfXkZeC6FGBU9ctnKwh0StTSkTNrFMmseAsogmz+D4rXntg7Gd8NYzFjMBBb2CmsiqPRU5d24pKNKMZMPx/HyXVw4Gss1VZW8tg57VQxdCQ79bH0=',s:[0xe4943572dc,0xa79cca1c88],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='/cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
</html>
