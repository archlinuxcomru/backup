


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Просветите по raid/lvm
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/posts/" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/topics/" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="/">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="/news/">Новости</a></li>
    <li class="active"><a href="/forum/">Форум</a></li>
    <li class=""><a href="/blogs/">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_%28%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9%29">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="/irc/#chat">IRC</a></li>
      <li class="dropdown">
        <a href="/accounts/login/" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="/accounts/login/">Вход</a></li>
          <li><a href="/accounts/register/">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="/messages/inbox/" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="/">ArchLinux.org.ru</a></li>


    <li><a href="/forum/">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="/forum/category/2/">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="/forum/forum/12/">Ядро и Железо</a> <span class="divider">/</span></li>
            
        
        
            <li>Просветите по raid/lvm</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>Просветите по raid/lvm</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-31699"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/gard/">
                <span class="post-username">gard</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/31699/">#</a>
            10 лет, 8 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/5c/f5/5cf5a07c0739d7bc6ac7ac27f4f6a0be.png" alt="gard avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/gard/topics/">
                    66
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/gard/posts/">
                    1167
                </a>
            </div>
            <div>
                Участник с: 15 декабря 2009
            </div>
            
        </td>
        <td class="post-content">
            Привет всем!<br/>Сегодня экспериментировал. Поставил арч на массив, если подробно то<br/>- было 2 диска, старые максторы 80гб<br/>- сделал на них по 2 раздела, 100М и 75000М<br/>- собрал массив raid1 из первых разделов каждого диска, обозвал <strong>/dev/md0</strong> (100M с &ndash;metadata=0.90)<br/>- собрал массив raid0 из вторых разделов каждого диска, обозвал <strong>/dev/md1</strong> (75000M + 75000M)<br/>- создал <strong>lvm-группу</strong> из физических томов, точнее уже из логического /dev/md1, обозвал mainVg (группа поверх raid0)<br/>- создал 2 логических тома lvm, <strong>lvswap</strong> и <strong>lvroot</strong> в вышесозданной группе<br/>- приступил к установке Арча, под <strong>/boot</strong> выделил <strong>/dev/md0</strong>, под <strong>swap</strong> выделил <strong>lvswap</strong>, под <strong>/</strong> выделил <strong>lvroot</strong><br/>- поправил <strong>mkinitcpio.conf</strong>, добавив в модули &ldquo;dm-raid&rdquo; и в хуки &ldquo;mdadm lvm2&rdquo; после udev, поставил grub на каждый диск (sda, sdb)<br/>- поставился, протестировал, скорость массива в 2 раза выше, в &ldquo;начале&rdquo; массива 160Мб/с на линейном чтении против 80Мб/с отдельного диска из этого же массива. В общем понравилось.<br/><br/>Но вот все таки есть кое какие вопросы, которые я немного недопонимаю. После сборки массива, во время установки Арча, когда дело доходит до правки конфигов, в /mnt подмонтируется /mnt/etc будущей системы, я в это время делал:<div class="code"><pre>mdadm --examine --scan &gt; /mnt/etc/mdadm.conf</pre></div>чтобы сохранить конфигурацию массива для будущей загрузки системы, ведь в /boot/grub/menu.lst корень указывал на lvroot, который находился в lvm-группе mainVg, расположившейся поверх raid0 /dev/md1. Кроме того в mdadm.conf пришлось прописать <div class="code"><pre>HOMEHOST myhost </pre></div>Уж не знаю как оно связано, но если не указать тут имя хоста (которое и в rc.conf и в hosts), то после перезагрузки системы мы получим массивы типа /dev/md125, /dev/md126 или 127. Наверное это какой то баг, встречается мне не первый раз. Прописывание имени хоста спасает, почему я незнаю =). <br/><br/>Теперь собственно ближе к вопросам. Как я понимаю, можно при создании разделов указать тип раздела linux raid autodetect. Я этого в общем то не делал. По сути при загрузке и обработке хуков после udev система должна загрузиться с lvroot, который расположился поверх md1. Каким образом здесь может прочитаться /etc/mdadm.conf, если для его чтения нужно собрать массив и инициализировать lvm-группу и тома? Бывает, что в /boot/grub/menu.lst указывается расположение корня на массиве к примеру так <div class="code"><pre>root=/dev/md1 md=1,/dev/sda2,/dev/sdb2</pre></div>Я такого не делал, у меня был указан пусть именно к lvm-тому lvroot, как то так: /dev/mapper/mainVg-lvroot (могу ошибиться, не помню точно формат именования). Вот и получается что курица вперед яйца. Если предположить, что система с помощью отработки хука mdadm сама &ldquo;автоопределяет&rdquo; массивы без конфига /etc/mdadm.conf и то же самое делает lvm, то как это происходит? За это отвечают суперблоки массива? Как я понял суперблок массива это место служебной информации о массиве на диске, что-то вроде типа раздела в таблице разделов? Но опять таки, если не происходит чтения файла /etc/mdadm.conf, в котором указан хостнейм, то почему массив собирается правильно, а не md. В общем я просто не могу понять порядок сего магического действа. Что происходит при загрузке, что и откуда читается, как определяется и инициализируется массив, откуда берется информация о том, как это сделать. То же самое с lvm, тоже какой то &ldquo;autodetect&rdquo; видимо. Читается ли при сборке массива вообще /etc/mdadm.conf и как он может читаться, если для его чтения надо сначала собрать массив, инициализировав его и lvm поверх него?<br/><br/>ps: простите, если много написал, знаю, что вопросы банальны, но не дайте запутаться, внесите ясность. =)
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-31700"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/gard/">
                <span class="post-username">gard</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/31700/">#</a>
            10 лет, 8 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/5c/f5/5cf5a07c0739d7bc6ac7ac27f4f6a0be.png" alt="gard avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/gard/topics/">
                    66
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/gard/posts/">
                    1167
                </a>
            </div>
            <div>
                Участник с: 15 декабря 2009
            </div>
            
        </td>
        <td class="post-content">
            Сам же отвечаю на свой вопрос, докопался до истины кажется, цитирую: <blockquote>Массивы всех уровней помимо блоков данных и суперблоков с контрольными суммами могут также содержать специальный суперблок (persistent superblock), который располагается в начале всех дисков массива и содержит информацию о конфигурации MD-устройства. Наличие отдельного суперблока позволяет ядру операционной системы получать информацию о конфигурации устройства RAID прямо с дисков, а не из конфигурационного файла, что может быть полезным, если файл по каким-то причинам перестанет быть доступным. Кроме того, наличие отдельного суперблока — необходимое условие автоопределения RAID-устройств при загрузке системы.</blockquote>Вот как оно автоматически собирает массив при запуске.. надо будет еще поэксперементировать, не пойму почему тогда md присваиваются не те имена (125-127), если конфиг в обоих случаях изначально недоступен..
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-31701"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/gard/">
                <span class="post-username">gard</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/31701/">#</a>
            10 лет, 8 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/5c/f5/5cf5a07c0739d7bc6ac7ac27f4f6a0be.png" alt="gard avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/gard/topics/">
                    66
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/gard/posts/">
                    1167
                </a>
            </div>
            <div>
                Участник с: 15 декабря 2009
            </div>
            
        </td>
        <td class="post-content">
            В общем решил написать сюда еще некоторые свои наблюдения. Суперблок, описывающий конфигурацию массива для автодетектирования находится не в начале диска, а в конце, кто-то говорит, что в &ldquo;конце, а может быть и в середине&rdquo;. Но не суть, в общем он там есть и можно пользоваться преимуществами. При создании массива, к примеру /dev/md0 ему присваивается минорный номер 0, посмотреть это можно в выводе mdadm -Q- D /dev/md0, подробнее тут: <a href="http://gentoo.theserverside.ru/book/ar68s14.html">http://gentoo.theserverside.ru/book/ar68s14.html</a> <br/><br/>Интересно несколько другое, что за баг с превращением в md125-127. Итак, я взял диск с убунтой, хотел поставить тестово ее, но не вышло, она не хочет ставиться на рейд или lvm, при выборе мест монтирования и ФС не доступен пункт &ldquo;изменить&rdquo;, где можно указать точку монтирования и тип ФС в инсталляторе, он понимает только физ. диски, что собственно говоря странно, арч-инсталлятор понимает все блочные устройства, в т.ч. device-mapper, на котором и основаны устройства с mdadm. Дак вот, создал под убунтой 2 массива: /dev/md0 и /dev/md1. Перед этим как надо, то есть тип диска был указан как raid autodetect.  После этого загрузился с archBootCD(dualCore) и продолжил эксперименты. Что примечательно массивы md0 и md1 стали под арчем md126 и md127, посмотрел вывод для каждого из них, к примеру mdadm -Q -D /dev/md126 и их минорные номера были 126 и 127, как могли произойти изменения с суперблоках я незнаю. Исправил суперблоки командой:<br/><div class="code"><pre>madam -S /dev/md0
mdadm --assemble --update=super-minor /dev/md0 /dev/sda1 /dev/sdb1</pre></div>Это исправило суперблок 126 для md0 на 0, как оно и должно быть. Кстати, если вы не можете переформатировать диски, которые были в массиве и наблюдаете странные вещи, то вам нужно очистить суперблоки, чтобы массивы автоматически не собирались. Сначала нужно их состановить: mdadm -S /dev/md0 а потом очистить суперблоки: madadm &ndash;zero-superblock /dev/md0, после этого информация о массивах из суперблоков будет удалена полностью и можно делать с дисками что угодно. <br/><br/>Дак вот, я сменил минорные номера на 0 и 1 для своих массивов и начал установку, установщик не нашел томов с lvm, ну что же, lvm были удалены и нарезаны заново. После этого установщик их обнаружил, хотя система в общем то видела старые тома lvm, но установщик не хотел их обнаруживать. Далее поставился и перезагрузился.. Каково же было мое удивление, когда система запустилась, но массивы оказались опять таки /dev/md126 и /dev/md127. Тем не менее все работало, почему так - я не знаю. Очень тонкий момент в том, что если вы используете lvm с mdadm, то lvm группа разделов привязана к md-устройствам, это в принципе понятно, но об этом можно забыть. Почему меняется минорный номер.. непонятно, но lvm группа как и была на /dev/md126 и прекрасно заработала. Это видимо какой то баг не иначе. <br/><br/>Как говорится &ldquo;внимательный читатель&rdquo; уже понял, что /dev/mdadm.conf ни разу не был упомянут. Да все верно, этот конфиг в этот раз я вообще не трогал, в нем просто нет необходимости, если используются суперблоки и тип раздела &ldquo;raid autodetect&rdquo;. Ядро с хуком mdadm автоматически находит и объединяет разделы raid, считывая информацию с суперблоков этих разделов. Это по настоящему круто. =) По другому в принципе и не может быть, если хранить конфиг массива отдельно и если он жизненно необходим для сборки массива, то массив не собрать, не прочитав конфиг, и если конфиг не прочитать, не собрав массив, то все плохо. А тут все работает. <br/><br/>Оказывается raid не так уж далек он народа, с учетом офигенного прироста скорости х2 на raid0 из двух томов или х3 из 3х томов, такой вот рэйд под систему и файлы будет очень крут, для домашних типовых задач самое то, все что потеряется при выходе из строя диска (все потеряется) не так уж страшно. Можно хранить отдельную важную информацию на отдельном диске. Бывает, советуют часть диска выделять под raid0, часть под raid5 к примеру, или raid1. Берем 3 диска, делаем на них 3 массива по 3 рездела дисков, raid1 под /boot, raid0 под корень, raid5 под важные файлы, по сути должно получиться быстро и красиво. =) Хотя если подумать, то все мы экстремальщики, у всех система работает с 1го диска и не жужжит, если диск умрет, то финиш. ))) Так что между просто диском и raid0 не такая уж большая разница. <br/><br/>Ну в общем я кажется изложил свои наблюдения, простите, если в тексте есть ошибки, я просто немного под шафе. ))
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="/accounts/register/">Зарегистрироваться</a> или <a href="/accounts/login/?next=/forum/topic/3068/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script>(function(){var js = "window['__CF$cv$params']={r:'747a74acda9e9d75',m:'BF593A_uM64Gp_9YURFWbGRdbx0b0xgg2ZenV8SpOrg-1662669176-0-AWM9ddZ5kaCV+p8eA2Foe13JaLAhAekiKmciJy+fjJ8O9Y40c673m1Zz7+fxlhc2u9lovlD1oCo9/J0fvn1vkeCPBdXxSqa3nXj17nX/NBeqKEMYwn6qrAdyxNnJFmGhPYSyUnKkkH0Q9ZS5HQ0D3zM=',s:[0x5e86ac7f08,0xa16ec81607],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='/cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
</html>
