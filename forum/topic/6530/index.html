


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        [Iptables] NF_CONNTRACK
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/posts/" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/topics/" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="/">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="/news/">Новости</a></li>
    <li class="active"><a href="/forum/">Форум</a></li>
    <li class=""><a href="/blogs/">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_%28%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9%29">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="/irc/#chat">IRC</a></li>
      <li class="dropdown">
        <a href="/accounts/login/" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="/accounts/login/">Вход</a></li>
          <li><a href="/accounts/register/">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="/messages/inbox/" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="/">ArchLinux.org.ru</a></li>


    <li><a href="/forum/">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="/forum/category/2/">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="/forum/forum/13/">Сети, Серверы, Защита</a> <span class="divider">/</span></li>
            
        
        
            <li>[Iptables] NF_CONNTRACK</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>[Iptables] NF_CONNTRACK</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63020"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/kernelpanic/">
                <span class="post-username">kernelpanic</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63020/">#</a>
            12 лет, 4 месяца назад
            
                (отредактировано
                
                    12 лет, 4 месяца назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/kernelpanic/topics/">
                    17
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/kernelpanic/posts/">
                    452
                </a>
            </div>
            <div>
                Участник с: 14 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            Добрый день всем. Насколько я понимаю то соединение по протоколу TCP устанавливается обменом 3 пакетов SYN -&gt; ACK -&gt; ACK &#8230;. -&gt; FIN после чего соединение становится ESTABLISHED. В Iptables есть модуль который отслеживает состояния соединений и на основе правил принимается решение о дальнейшей судьбе пакета. <br/>Вопрос собственно состоит в том достаточно ли для защиты от посягательств извне -A INPUT -ppp0 -m conntrack &ndash;ctstate ESTABLISHED,RELATED -j ACCEPT для tcp соединений? Может ли каким нибудь образом TCP соединение стать ESTABLISHED если первый пакет исходит не от меня а из интернетов? <br/>Хочу применить данную политику дабы не писать мильён правил. Так по моему гораздо проще, все соединения которые инициализируются мной - пропускаются (-j ACCEPT), все что пришло извне дропается за исключением нескольких конкретно прописанных правил. <br/>Для UDP : <br/>-A INPUT -i ppp0 -p udp &ndash;some-sport &ndash;some-dport -j ACCEPT<br/>&#8230;.<br/>-A INPUT -i ppp0 -p udp -j DROP<br/>Я на верном пути? Гуру подскажите.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63021"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/cac2s/">
                <span class="post-username">cac2s</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63021/">#</a>
            12 лет, 4 месяца назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/cac2s/topics/">
                    6
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/cac2s/posts/">
                    277
                </a>
            </div>
            <div>
                Участник с: 10 января 2009
            </div>
            
        </td>
        <td class="post-content">
             <a href="http://gazette.linux.ru.net/rus/articles/iptables-tutorial.html">http://gazette.linux.ru.net/rus/article &#8230; orial.html</a> <br/>крайне рекомендую распечатать. отличное руководство.<br/> по сабжу: немного непонятно. давай подробнее, что нужно сделать? что извне пускать, что нет. и где ты находишься? немного сбивает с толку<br/><blockquote>если первый пакет исходит не от меня а из интернетов<br/></blockquote>если ты в локалке - зачем тогда<br/><div class="code"><pre>-i ppp0 -p udp -i ppp0 -p udp -j ACCEPT</pre></div>и почему два раза :)
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63022"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/kernelpanic/">
                <span class="post-username">kernelpanic</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63022/">#</a>
            12 лет, 4 месяца назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/kernelpanic/topics/">
                    17
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/kernelpanic/posts/">
                    452
                </a>
            </div>
            <div>
                Участник с: 14 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>cac2s</em><br/><a href="http://gazette.linux.ru.net/rus/articles/iptables-tutorial.html">http://gazette.linux.ru.net/rus/articles/iptables-tutorial.html</a><br/>крайне рекомендую распечатать. отличное руководство.<br/> по сабжу: немного непонятно. давай подробнее, что нужно сделать? что извне пускать, что нет. и где ты находишься? немного сбивает с толку</blockquote><br/><br/>А существующие правила я с помощью libastral.so сгенерил? Читал я туториал. Я просто хотел удостовериться.<br/>Одна сетевуха с интерфейсами ppp0 (ADSL) и собственно eth0. Нужно все выпускать и аццептить соединения которые инициалиризовались моей машиной и которые уходят через ppp0 в интернеты. А пускать нужно только на 80 порт и еще несколько для которых прописаны правила отдельные. Тобишь цель создать политику для TCP соединений чтобы извне пускать только то что открыто, все остальное дропать. Инициализированные мной соединения будут иметь статус ESTABLISHED и будут аццептится. Ведь так гораздо проще чем писать правило на каждое приложение и их порты. <br/><br/><br/><blockquote><em>Kernel_panic</em><br/>если первый пакет исходит не от меня а из интернетов</blockquote><br/><blockquote><em>cac2s</em><br/>если ты в локалке - зачем тогда<br/><div class="code"><pre>-i ppp0 -p udp -i ppp0 -p udp -j ACCEPT</pre></div>и почему два раза :)</blockquote>Два раза потому что как я понял порядок записи правил очень важен.<br/>Открываем нужный порт по UDP, остальное дропаем, так как CONNTRACK естественно не может работать с UDP и для него свои политики.<br/>Вторым правилом все остальное по UDP дропаем. Если поменять местами, то iptables заблокирует весь UDP траффик и следующее правило не будет обрабатвываться. Возможно я ошибаюсь.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63023"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/cac2s/">
                <span class="post-username">cac2s</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63023/">#</a>
            12 лет, 4 месяца назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/cac2s/topics/">
                    6
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/cac2s/posts/">
                    277
                </a>
            </div>
            <div>
                Участник с: 10 января 2009
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>kernel_panic</em><br/>А существующие правила я с помощью libastral.so сгенерил? Читал я туториал.<br/></blockquote>либо читал невнимательно/&ldquo;для галочки&rdquo;, либо лень-матушка переборола, ибо все просто:<br/><div class="code"><pre># политики по умолчанию (INPUT, FORWARD - запрещено всё, кроме того, что разрешено)
iptables -P INPUT DROP
iptables -P FORWARD DROP
# разрешаем весь исходящий трафик
iptables -P OUTPUT ACCEPT
# пускаем входящие пакеты установленных и связанных соединий
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# разрешаем входящие пакеты для 127.0.0.1
iptables -A INPUT -i lo -j ACCEPT
# пускаем http
iptables -A INPUT -p tcp -i ppp0 --dport 80 -j ACCEPT
...
# и т.д.</pre></div><br/><blockquote><em>kernel_panic</em><br/>Два раза потому что как я понял порядок записи правил очень важен.<br/>Открываем нужный порт по UDP, остальное дропаем, так как CONNTRACK естественно не может работать с UDP и для него свои политики.<br/>Вторым правилом все остальное по UDP дропаем. Если поменять местами, то iptables заблокирует весь UDP траффик и следующее правило не будет обрабатвываться. Возможно я ошибаюсь.<br/></blockquote>я имел ввиду, конкретно в строке <em>-i ppp0 -p udp -i ppp0 -p udp -j ACCEPT</em> дважды указываешь интерфейс и протокол
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63024"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/kernelpanic/">
                <span class="post-username">kernelpanic</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63024/">#</a>
            12 лет, 4 месяца назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/kernelpanic/topics/">
                    17
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/kernelpanic/posts/">
                    452
                </a>
            </div>
            <div>
                Участник с: 14 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            Прочитай еще раз первый пост. Я не спрашивал как это сделать. <br/>Да, и state это гумно мамонта.<br/>P.S. про повторяющиеся интерфейсы конечно же опечатка
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63025"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/cac2s/">
                <span class="post-username">cac2s</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63025/">#</a>
            12 лет, 4 месяца назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/cac2s/topics/">
                    6
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/cac2s/posts/">
                    277
                </a>
            </div>
            <div>
                Участник с: 10 января 2009
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>kernel_panic</em><br/>Прочитай еще раз первый пост. Я не спрашивал как это сделать. <br/>Да, и state это гумно мамонта.<br/>P.S. про повторяющиеся интерфейсы конечно же опечатка</blockquote>какие мы нервные! :) для начала глаза открой шире:<br/><blockquote><em>kernel_panic</em><br/>Нужно все выпускать и аццептить соединения которые инициалиризовались моей машиной и которые уходят через ppp0 в интернеты.</blockquote><div class="code"><pre># политики по умолчанию (INPUT, FORWARD - запрещено всё, кроме того, что разрешено)
iptables -P INPUT DROP
iptables -P FORWARD DROP
# разрешаем весь исходящий трафик
iptables -P OUTPUT ACCEPT</pre></div><blockquote><em>kernel_panic</em><br/>Тобишь цель создать политику для TCP соединений чтобы извне пускать только то что открыто, все остальное дропать. А пускать нужно только на 80 порт и еще несколько для которых прописаны правила отдельные.</blockquote><div class="code"><pre># пускаем http
iptables -A INPUT -p tcp -i ppp0 --dport 80 -j ACCEPT</pre></div><blockquote><em>kernel_panic</em><br/>Инициализированные мной соединения будут иметь статус ESTABLISHED и будут аццептится. </blockquote>как iptables должен тебя &ldquo;узнавать&rdquo;? по ip/mac/etc.? или, может быть, ты имеешь ввиду доступ к 80-му порту с localhost? никто угадывать не будет.<br/>повторю: либо прочти мануал и сам сделай, либо перестань выкукоживаться и нормально сформулируй задачу с _полным_ описанием сети, и чётко сформулированными требованиями.<br/><br/>з.ы.:<br/><blockquote><em>kernel_panic</em><br/>Да, и state это гумно мамонта.</blockquote>необоснованный выхлоп. не более
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-63026"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/kernelpanic/">
                <span class="post-username">kernelpanic</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/63026/">#</a>
            12 лет, 4 месяца назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/kernelpanic/topics/">
                    17
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/kernelpanic/posts/">
                    452
                </a>
            </div>
            <div>
                Участник с: 14 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            Никогда я не умел нормально объяснять&#8230;.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="/accounts/register/">Зарегистрироваться</a> или <a href="/accounts/login/?next=/forum/topic/6530/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script>(function(){var js = "window['__CF$cv$params']={r:'747bbbddeb3215ee',m:'u5K7uOeL3_Br8qG9snmIeViW7PPOT58aIrW1qhjA3bk-1662682572-0-Aes2RiOjryo+R39BCbwA0WMHDbp4lifzAhdbADkfXI+O6Bem4dYF479egK1KD3qA/sDY30k/feQ2nxWh8NLoGBzfbt2kyneSyBezdDxY9SqRDCEVYFuG06EYtB43Qo/4FNlI57xOr8/Exb6AmpuSQwg=',s:[0xa2066306ef,0x0d09212338],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='/cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
</html>
