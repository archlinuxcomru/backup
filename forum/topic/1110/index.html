


<!DOCTYPE html>
<html lang="ru">

<!-- Mirrored from archlinux.org.ru/forum/topic/1110/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 08 Sep 2022 04:13:42 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Перезагрузка псевдодемонов в systemd и её последствия
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://archlinuxcomru.github.io/backup/src/css/bootstrap.css">
    
    
    

    <script type="text/javascript" src="https://archlinuxcomru.github.io/backup/src/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://archlinuxcomru.github.io/backup/src/js/bootstrap.js"></script>
    <script type="text/javascript" src="https://archlinuxcomru.github.io/backup/src/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="../../feeds/posts/index.html" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="../../feeds/topics/index.html" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="../../../index.html">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="../../../news/index.html">Новости</a></li>
    <li class="active"><a href="../../index.html">Форум</a></li>
    <li class=""><a href="../../../blogs/index.html">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_(Русский)">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="../../../irc/index.html#chat">IRC</a></li>
      <li class="dropdown">
        <a href="../../../accounts/login/index.html" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="../../../accounts/login/index.html">Вход</a></li>
          <li><a href="../../../accounts/register/index.html">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="../../../messages/inbox/index.html" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="../../../index.html">ArchLinux.org.ru</a></li>


    <li><a href="../../index.html">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="../../category/2/index.html">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="../../forum/23/index.html">Демоны и загрузка системы</a> <span class="divider">/</span></li>
            
        
        
            <li>Перезагрузка псевдодемонов в systemd и её последствия</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>Перезагрузка псевдодемонов в systemd и её последствия</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-10809"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Natrio/index.html">
                <span class="post-username">Natrio</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/10809/index.html">#</a>
            10 лет назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/Natrio/topics/index.html">
                    47
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Natrio/posts/index.html">
                    4763
                </a>
            </div>
            <div>
                Участник с: 08 января 2011
            </div>
            
        </td>
        <td class="post-content">
            Допустим, у нас есть такой псевдодемон: <div class="code"><pre>[Unit]
Description=Iptables Firewall
Wants=network.target
Before=network.target
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/etc/net/filter start
ExecStop=/etc/net/filter stop
[Install]
WantedBy=multi-user.target</pre></div>То есть на старт и стоп просто вызывается скрипт, который загружает, либо очищает правила фаерволла.<br/><br/>Также допустим, что мы хотим, чтобы некоторые демоны запускались только при поднятом фаерволле, и для этого привязываем их к нему через Requires=<br/><br/>А потом мы вдруг исправили конфиг файрволла, и хотим обновить правила. Если сделать это через restart, то все &ldquo;привязанные&rdquo; к нему демоны тоже перезагрузятся, чего нам совсем не надо. Если же попробовать сделать это через reload, то выясняется, что псевдодемону (Type=oneshot), который фактически не имеет процесса в памяти, невозможно придать параметр ExecReload= , это трактуется как ошибка. Сделать это через start тоже не получится, так как до вызова stop псевдодемон считается запущенным.<br/><br/>Спрашивается, что в этом случае делать?<br/>Я пока просто убрал Requires, чтобы можно было делать restart но мне это активно не нравится. Конечно, можно обновлять фаерволл и мимо systemd, но пока я всё ещё надеюсь, что удастся обойтись без этого.<br/><br/><em>P.S.</em><br/>Поставил в зависимый юнит Wants= вместо Requires=<br/>При старте второй действительно тянет за собой первый, но при отключении первого второй остаётся. Вариант так себе&#8230;
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-10810"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/sleepycat/index.html">
                <span class="post-username">sleepycat</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/10810/index.html">#</a>
            10 лет назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/f2/c0/f2c02cdf7ab1395c1ebcd403ff0c9d53.png" alt="sleepycat avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/sleepycat/topics/index.html">
                    98
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/sleepycat/posts/index.html">
                    3291
                </a>
            </div>
            <div>
                Участник с: 19 июля 2011
            </div>
            
        </td>
        <td class="post-content">
            ятак и не понял чего вы хотите добиться, вы уж определитесь с юнитом, какнито. <br/>Вообще то что Вы описываете как бы реагирует так как и должно. Т.е. если мы так строго привязываем один юнит к другому, то понятно дело что он будет как слепой за повадырем.<br/>А вообще интуитивно возник вопрос, а на отбой (hup) фильтр не реагирует, я както до системд думал об этом, но этож фильтр а не программа&#8230; т.е. в инитскриптах такого шика не было вообще, т.е. подобный вопрос даже не возникал. Здесь же вдруг надо статично привязать фаер к др. демону, однако раз уж есть функционал, надо бы его реализовать. Первое что думается, это методы костылей, т.е. HUP. Второе интуитивное это попробовать найти тип в котором сможем добавить релоад.<br/>Вот мой штатный юнит, сегодня вечером попытаюсь чтонито придумать с ним, чтобы без stop обойтись. Написал сугубо для стимуляции мыслей, может кого осенит после прочтения.<br/><div class="code"><pre>
└─&gt;&gt; cat /usr/lib/systemd/system/iptables.service 
[Unit]
Description=Packet Filtering Framework
[Service]
Type=oneshot
ExecStart=/usr/sbin/iptables-restore /etc/iptables/iptables.rules
ExecStop=/usr/lib/systemd/scripts/iptables-flush
RemainAfterExit=yes
[Install]
WantedBy=multi-user.target</pre></div>PS<br/><blockquote>Если сделать это через restart, то все &ldquo;привязанные&rdquo; к нему демоны тоже перезагрузятся, чего нам совсем не над</blockquote>к сожалению так обычно и делают, чтобы не допустить утечки или чегото подобного. Ну по крайнер мере я везде читал такие тенденции, но учитывая тенденции привязки, думаю что решение вопроса будет тоже мне интересно,поэтому я отведу часть времени позже на изучении и отпишусь. Однако для этого мне нужно авансов осилить и как следует понять отношения меж Requires и wants. Может я что найду в мане параллельно . Вопрос страный , вроде бы обычно для такого хватала After, а если привязал то будь добр&#8230;. однако как бы так жестко привязать и найти способ &ldquo;без отдачи&rdquo;. Думаю все же это не проблема системы как таковой, а проблема юнита&#8230;. все сегодня сажусь за мат.часть по юнитам в крайнем случае по служебным, пора бы прояснить все точки над `и`. )))
            
                
                    <div class="post-signature">
                        Лозунг у них был такой: &quot;Познание бесконечности требует бесконечного времени&quot;. С этим я не спорил, но они делали из этого неожиданный вывод: &quot;А потому работай не работай — все едино&quot;. И в интересах неувеличения энтропии Вселенной они не работали. (с)
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-10811"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Natrio/index.html">
                <span class="post-username">Natrio</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/10811/index.html">#</a>
            10 лет назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/Natrio/topics/index.html">
                    47
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Natrio/posts/index.html">
                    4763
                </a>
            </div>
            <div>
                Участник с: 08 января 2011
            </div>
            
        </td>
        <td class="post-content">
            <strong>iptables.service</strong> тут ничем не лучше. А не использую я его потому, что мне надо перезагрузить только <strong>filter</strong>, а <strong>nat</strong> и <strong>mangle</strong> оставить без изменений.<br/><br/>Дело тут даже не в проблеме с &ldquo;привязкой&rdquo;, которая в случае псевдодемона без процесса чисто формальная, и формализуется не совсем так, как хотелось бы, а в этом дурацком ограничении на действия с псевдодемоном – start/stop пожалуйста, а reload – не моги.<br/>Можно найти и другие аналогичные ситуации, когда такому &ldquo;демону&rdquo; безо всякой &ldquo;привязки&rdquo; понадобится больше двух действий, а повесить их не на что, даже reload отобрали&#8230;
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-10812"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/sleepycat/index.html">
                <span class="post-username">sleepycat</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/10812/index.html">#</a>
            10 лет назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/f2/c0/f2c02cdf7ab1395c1ebcd403ff0c9d53.png" alt="sleepycat avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/sleepycat/topics/index.html">
                    98
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/sleepycat/posts/index.html">
                    3291
                </a>
            </div>
            <div>
                Участник с: 19 июля 2011
            </div>
            
        </td>
        <td class="post-content">
            вообщем удалось заставить прописаться правилам на стандартном конфиге удалив remain after и execstop. <br/>2. я так понимаю (почти перевел все) что в типе форк все работает, что мешает сделать тип форк. как я понял ничего фатального не будет.<br/>упд.<br/>Торопился, поэтому сейчас  уточню, правила стали записываться при повтороном старте, что в моем случае не страшно (конфиг правил на всякий пожарный перед пуском сам сбрасывает правила, поэтому мне для данной задачи стоп не нужен как таковой), но как то все стало выглядить не красиво. <br/>Сейчас я переввел текст ман страницы сервисов, могу сказать уверено, что с полем тип в юните можно играть свободно, так как для системд это не указание к действиям а скорее чтото вроде совета, т.е. истина в том, что чем точнее мы опишем процесс тем больше встроенных ффункций сиистемд отработают как надо. Т.е. если мы поставим форк, то система просто будет ждать иксита главного процессса, и только плсе этого оно будет думать, что все красиво и продолжить инициализацию. Natrio можете попробовать с типом форк? будет ли оно читсо гипотетически работать так как надо вам? у меня просто не хватило времени чтобы проверить, адо завтрашнего, т.е . сегоднейшего обеда я походу не проснусь)))
            
                
                    <div class="post-signature">
                        Лозунг у них был такой: &quot;Познание бесконечности требует бесконечного времени&quot;. С этим я не спорил, но они делали из этого неожиданный вывод: &quot;А потому работай не работай — все едино&quot;. И в интересах неувеличения энтропии Вселенной они не работали. (с)
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="../../../accounts/register/index.html">Зарегистрироваться</a> или <a href="../../../accounts/login/indexc58f.html?next=/forum/topic/1110/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

</body>

<!-- Mirrored from archlinux.org.ru/forum/topic/1110/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 08 Sep 2022 04:13:42 GMT -->
</html>
