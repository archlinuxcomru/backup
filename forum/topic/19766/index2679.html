


<!DOCTYPE html>
<html lang="ru">

<!-- Mirrored from archlinux.org.ru/forum/topic/19766/?page=1 by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 08 Sep 2022 08:49:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        SSLH: Transparent Proxy, правила iptables, ip
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="../../feeds/posts/index.html" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="../../feeds/topics/index.html" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="../../../index.html">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="../../../news/index.html">Новости</a></li>
    <li class="active"><a href="../../index.html">Форум</a></li>
    <li class=""><a href="../../../blogs/index.html">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_(Русский)">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="../../../irc/index.html#chat">IRC</a></li>
      <li class="dropdown">
        <a href="../../../accounts/login/index.html" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="../../../accounts/login/index.html">Вход</a></li>
          <li><a href="../../../accounts/register/index.html">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="../../../messages/inbox/index.html" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="../../../index.html">ArchLinux.org.ru</a></li>


    <li><a href="../../index.html">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="../../category/2/index.html">Поддержка пользователей</a> <span class="divider">/</span></li>
            
                <li><a href="../../forum/13/index.html">Сети, Серверы, Защита</a> <span class="divider">/</span></li>
            
        
        
            <li>SSLH: Transparent Proxy, правила iptables, ip</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>SSLH: Transparent Proxy, правила iptables, ip</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226953"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Nebulosa/index.html">
                <span class="post-username">Nebulosa</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226953/index.html">#</a>
            2 года, 6 месяцев назад
            
                (отредактировано
                
                    2 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/4a/9b/4a9bd66c7a2a170b1585f3b56cdb48de.png" alt="Nebulosa avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/Nebulosa/topics/index.html">
                    10
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Nebulosa/posts/index.html">
                    830
                </a>
            </div>
            <div>
                Участник с: 05 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            Продолжаю настраивать vds, столкнулся с небольшой проблемой.<br /><br />Установлен и настроен <a href="https://www.rutschle.net/tech/sslh/README.html">sslh</a>  всё работает, но программы не видят внешний IP соединений.<br /><br />Например:<br /><pre><code>➤[Connected 23 Feb 2020, 09:11:18]
Last login: Sun Feb 23 08:13:05 2020 from 127.0.0.1
[<a href="../../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="c2aca7a0b7aeadb1a382b4a6b1">[email&#160;protected]</a> ~]$</code></pre><br />В документации есть инструкция, необходимо применить следующие правила (сразу пишу с поправкой на свои реалии):<br /><pre><code>sudo iptables -t mangle -N SSLH
sudo iptables -t mangle -A  OUTPUT --protocol tcp --out-interface ens3 --sport 22 --jump SSLH
sudo iptables -t mangle -A OUTPUT --protocol tcp --out-interface ens3 --sport 443 --jump SSLH
sudo iptables -t mangle -A SSLH --jump MARK --set-mark 0x1
sudo iptables -t mangle -A SSLH --jump ACCEPT
sudo ip rule add fwmark 0x1 lookup 100
sudo ip route add local 0.0.0.0/0 dev lo table 100</code></pre><br />После применения последней команды - сервер перестаёт принимать соединения.<br />Подозреваю, что нужно как-то поменять ранг таблицы или прописать как-то ип, но для меня маршрутизация - это тёмный лес, прошу вашей помощи.<br /><br />Перед всеми действиями конфигурация сервера такая:<br /><pre><code>$ ip rule list
0:      from all lookup local
32766:  from all lookup main
32767:  from all lookup default
</code></pre><pre><code>$sudo iptables-save
*nat
:PREROUTING ACCEPT [8076:453873]
:INPUT ACCEPT [705:37884]
:OUTPUT ACCEPT [842:52367]
:POSTROUTING ACCEPT [176:9152]
-A POSTROUTING -o ens3 -j MASQUERADE
COMMIT
*filter
:INPUT DROP [7241:407167]
:FORWARD ACCEPT [44705:57871270]
:OUTPUT ACCEPT [288283:318921775]
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 8388 -j ACCEPT
-A INPUT -p udp -m udp --dport 3963 -j ACCEPT
-A INPUT -p udp -m udp --dport 8388 -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg0 -j ACCEPT
COMMIT
</code></pre><br /><pre><code>
$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq state UP group default qlen 1000
    link/ether 52:54:00:02:48:4a brd ff:ff:ff:ff:ff:ff
    inet &lt;my_IP_is_here&gt;/24 brd &lt;IP_gate_is_here&gt; scope global ens3
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe02:484a/64 scope link
       valid_lft forever preferred_lft forever
3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq state UNKNOWN group default qlen 100
    link/none
    inet 10.8.0.1/24 brd 10.8.0.255 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::be2c:6fd5:223b:842e/64 scope link stable-privacy
       valid_lft forever preferred_lft forever
4: wg0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
    link/none
    inet 10.66.66.1/24 scope global wg0
       valid_lft forever preferred_lft forever
    inet6 fd42:42:42::1/64 scope global
       valid_lft forever preferred_lft forever
</code></pre>
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226957"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/indeviral/index.html">
                <span class="post-username">indeviral</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226957/index.html">#</a>
            2 года, 6 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/indeviral/topics/index.html">
                    38
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/indeviral/posts/index.html">
                    3167
                </a>
            </div>
            <div>
                Участник с: 10 августа 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Nebulosa</em><br>сервер перестаёт принимать соединения</blockquote>По ssh не подключается?
            
                
                    <div class="post-signature">
                        Ошибки в тексте-неповторимый стиль автора©
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226958"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Nebulosa/index.html">
                <span class="post-username">Nebulosa</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226958/index.html">#</a>
            2 года, 6 месяцев назад
            
                (отредактировано
                
                    2 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/4a/9b/4a9bd66c7a2a170b1585f3b56cdb48de.png" alt="Nebulosa avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/Nebulosa/topics/index.html">
                    10
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Nebulosa/posts/index.html">
                    830
                </a>
            </div>
            <div>
                Участник с: 05 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            Не подключается к порту 443, за которым спрятано несколько сервисов.<br /><br />К порту 80, например, подключение идёт, всё ок.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226959"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/indeviral/index.html">
                <span class="post-username">indeviral</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226959/index.html">#</a>
            2 года, 6 месяцев назад
            
                (отредактировано
                
                    2 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/indeviral/topics/index.html">
                    38
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/indeviral/posts/index.html">
                    3167
                </a>
            </div>
            <div>
                Участник с: 10 августа 2013
            </div>
            
        </td>
        <td class="post-content">
            <strong>Nebulosa</strong><br />ну так всё правильно, вы просто не читали буквы?)<br /><br /><blockquote>The firewalling tables also need to be adjusted as follow. The example connects to HTTPS on 4443 – adapt to your needs ; I don’t think it is possible to have httpd listen to 443 in this scheme – let me know if you manage that:</blockquote><br /><blockquote>Note that these rules will prevent from connecting directly to ssh on the port 22, as packets coming out of sshd will be tagged. If you need to retain direct access to ssh on port 22 as well as through sslh, you can make sshd listen to 22 AND another port (e.g. 2222), and change the above rules accordingly.</blockquote>
            
                
                    <div class="post-signature">
                        Ошибки в тексте-неповторимый стиль автора©
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226968"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Nebulosa/index.html">
                <span class="post-username">Nebulosa</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226968/index.html">#</a>
            2 года, 6 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/4a/9b/4a9bd66c7a2a170b1585f3b56cdb48de.png" alt="Nebulosa avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/Nebulosa/topics/index.html">
                    10
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Nebulosa/posts/index.html">
                    830
                </a>
            </div>
            <div>
                Участник с: 05 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            То ли лыжи не едут... (с)<br /><br />Текст перевёл через переводчик еще раз, может я что-то упустил, но нет, вроде всё как и прочитал с первого раза..<br /><br />Еще, раз. У меня SSH доступен через порт 443. Через этот же порт работает openvpn. Все стандартные порты этих сервисов закрыты, открыт только 443. Всё работает, только сервисы видят соединение как внутреннее.<br /><br />Применяю правила по инструкции (указывая при этом ens3 и порт 443), порт 443 перестаёт отвечать - SSH  не соединяется, openvpn не работает.<br /><br />Что я пропустил?..
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226969"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/indeviral/index.html">
                <span class="post-username">indeviral</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226969/index.html">#</a>
            2 года, 6 месяцев назад
            
                (отредактировано
                
                    2 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/indeviral/topics/index.html">
                    38
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/indeviral/posts/index.html">
                    3167
                </a>
            </div>
            <div>
                Участник с: 10 августа 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Nebulosa</em><br>У меня SSH доступен через порт 443</blockquote>бывает...<br /><br />p.s. если вы хотите поизвращаться то более правильно взять взять домен, организовать десяток поддоменов на все случаи.<br />и организовать реверсивное proxy на nginx(ну или apache наверно тоже можно...) на разных поддоменнах.<br />можно даже локальные порты не занимать если использовать сокеты ещё красивее получится)<br /><br />p.p.s. хотя с точки зрения стабильности, если ляжет nginx ляжет всё, но для вас это не критично...<br /><br />p.p.p.s. секундочку, а смысл от sslh если у вас и так всё на одном порту весит?))<br />это вы наверно по умолчанию зачем-то в ssh указали 443, а в openvpn можно вроде указывать конструкцию что бы он был с чем-то на одном порту.
            
                
                    <div class="post-signature">
                        Ошибки в тексте-неповторимый стиль автора©
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226974"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Nebulosa/index.html">
                <span class="post-username">Nebulosa</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226974/index.html">#</a>
            2 года, 6 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/4a/9b/4a9bd66c7a2a170b1585f3b56cdb48de.png" alt="Nebulosa avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/Nebulosa/topics/index.html">
                    10
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Nebulosa/posts/index.html">
                    830
                </a>
            </div>
            <div>
                Участник с: 05 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            Подожду ещё ответы на, вроде бы, конкретный вопрос...
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226976"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Nebulosa/index.html">
                <span class="post-username">Nebulosa</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226976/index.html">#</a>
            2 года, 6 месяцев назад
            
                (отредактировано
                
                    2 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/4a/9b/4a9bd66c7a2a170b1585f3b56cdb48de.png" alt="Nebulosa avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/Nebulosa/topics/index.html">
                    10
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Nebulosa/posts/index.html">
                    830
                </a>
            </div>
            <div>
                Участник с: 05 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>indeviral</em><br>p.p.p.s. секундочку, а смысл от sslh если у вас и так всё на одном порту весит?))<br />это вы наверно по умолчанию зачем-то в ssh указали 443, а в openvpn можно вроде указывать конструкцию что бы он был с чем-то на одном порту.</blockquote><br />У меня там не только ssh и openvpn. 4 сервиса.<br /><br />Почему вообще sslh - данная конфигурация свела на нет брутфорсы. Ранее штатно работал sshguard, но правила iptables и логи росли в арифметической прогрессии. После 4500  permban ip за набранных всего за пару месяцев установил это решение. Ну и плюс удобно прятать сервисы, если вы понимаете о чём я.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-226978"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/indeviral/index.html">
                <span class="post-username">indeviral</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/226978/index.html">#</a>
            2 года, 6 месяцев назад
            
                (отредактировано
                
                    2 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="../../users/indeviral/topics/index.html">
                    38
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/indeviral/posts/index.html">
                    3167
                </a>
            </div>
            <div>
                Участник с: 10 августа 2013
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Nebulosa</em><br>Подожду ещё ответы на, вроде бы, конкретный вопрос&#8230;</blockquote>Так я же вам написал ответ? Какой вам ещё нужен?<br />Нужен другой порт для sslh либо для ssh(в вашем случаи), ну и отдельный порт для openvpn.<br /><a href="https://github.com/yrutschle/sslh/raw/master/doc/tproxy.svg?sanitize=true">ссылка</a>, может так понятнее?
            
                
                    <div class="post-signature">
                        Ошибки в тексте-неповторимый стиль автора©
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-227042"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="../../users/Nebulosa/index.html">
                <span class="post-username">Nebulosa</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="../../post/227042/index.html">#</a>
            2 года, 6 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/4a/9b/4a9bd66c7a2a170b1585f3b56cdb48de.png" alt="Nebulosa avatar" />
    
</div>

            <div>
                Темы:
                <a href="../../users/Nebulosa/topics/index.html">
                    10
                </a>
            </div>
            <div>
                Сообщения:
                <a href="../../users/Nebulosa/posts/index.html">
                    830
                </a>
            </div>
            <div>
                Участник с: 05 марта 2009
            </div>
            
        </td>
        <td class="post-content">
            В общем, помедитировал ещё раз над всеми инструкциями, но ситуация не поменялась.<br /><br />Понял, что проблема была в правиле: <pre><code>sudo iptables -t mangle -A OUTPUT --protocol tcp --out-interface ens3 --sport 443 --jump SSLH</code></pre><br />Насколько я понял, если есть несколько сервисов, то тут нужно прописать порты их всех, т.е, для SSH и Openvpn надо прописать:<br /><br /><pre><code>sudo iptables -t mangle -A  OUTPUT --protocol tcp --out-interface ens3 --sport 22 --jump SSLH
sudo iptables -t mangle -A  OUTPUT --protocol tcp --out-interface ens3 --sport 1194 --jump SSLH</code></pre><br />Но всё равно не помогло (остальные правила тоже прописал).<br /><br /><blockquote><em>indeviral</em><br>Так я же вам написал ответ? Какой вам ещё нужен?<br />Нужен другой порт для sslh либо для ssh(в вашем случаи), ну и отдельный порт для openvpn.</blockquote>Продолжаю продолжать... Все сервисы занимают свои порты (ssh - 22, openvpn 1194 и пр). Эти порты извне закрыты, наружу торчит только 443 (sslh) который уже работает с запросами. Всё настроено, всё работает, за исключением того, что все подключения (ip) сервисы видят как внутренние.<br /><blockquote><em>indeviral</em><br><a href="https://github.com/yrutschle/sslh/raw/master/doc/tproxy.svg?sanitize=true">ссылка</a>, может так понятнее?</blockquote>Схема хорошая, только у меня один хост, без роутера, sslh висит на 443 порту. Мне не нужен tsl доступ к серверу, так что у меня нет конфликта за порт 443. Моя схема в три раза проще, одинаковое лишь то, что каждый сервис на своём порту висит.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="../../../accounts/register/index.html">Зарегистрироваться</a> или <a href="../../../accounts/login/indexaa4e.html?next=/forum/topic/19766/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script data-cfasync="false" src="../../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){var js = "window['__CF$cv$params']={r:'745e26112f0c7b67',m:'IKEyl7dbPoVdeXSgcZZdz6P6TqTFAiC1ULDXpCNOcqc-1662372350-0-AfRy63ZVqx6rcR3COj75hzW/1P16A294dtbZLZ82B764rV+sd6YI1bXNQcGFL3L1i58LhJUCWfEiwsJvU9G1Jvb70/9XJL8rEZ2PaeMaE4eeukLNpg7DWBrqJfjSb54f9btxe4GPhxN5T9ESB1y9Cqc=',s:[0x4b44c3077e,0x21da6b431f],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='../../../cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible5615.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>

<!-- Mirrored from archlinux.org.ru/forum/topic/19766/?page=1 by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 08 Sep 2022 08:49:07 GMT -->
</html>
