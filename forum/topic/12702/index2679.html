


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Мой юниксвейный mnt. Часть 2: флешки, диски и прочие карточки.
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/posts/" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/topics/" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="/">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="/news/">Новости</a></li>
    <li class="active"><a href="/forum/">Форум</a></li>
    <li class=""><a href="/blogs/">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_%28%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9%29">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="/irc/#chat">IRC</a></li>
      <li class="dropdown">
        <a href="/accounts/login/" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="/accounts/login/">Вход</a></li>
          <li><a href="/accounts/register/">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="/messages/inbox/" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="/">ArchLinux.org.ru</a></li>


    <li><a href="/forum/">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="/forum/category/8/">Блоги</a> <span class="divider">/</span></li>
            
                <li><a href="/forum/forum/25/">Блоги</a> <span class="divider">/</span></li>
            
        
        
            <li>Мой юниксвейный mnt. Часть 2: флешки, диски и прочие карточки.</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>Мой юниксвейный mnt. Часть 2: флешки, диски и прочие карточки.</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124161"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/Natrio/">
                <span class="post-username">Natrio</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124161/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/Natrio/topics/">
                    47
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/Natrio/posts/">
                    4763
                </a>
            </div>
            <div>
                Участник с: 08 января 2011
            </div>
            
        </td>
        <td class="post-content">
            <em>Начало здесь:</em><br /><a href="https://archlinux.org.ru/forum/topic/12698/"><u>Часть 1: Системный диск, имена и группы.</u></a><br /><br /><strong>2.1. Монтирование: как это работает.</strong><br /><br />В прошлый раз я закончил на добавлении всех съёмных дисков в группу storage. А теперь о том, как я это использую.<br /><br />Идея проста – если пользователь имеет доступ к устройству, я сделаю так, чтобы он мог и монтировать. Если доступ только на чтение – монтируется на чтение. Не нужно никакой вторичной псевдоавторизации сеанса по родителю и страшных конфигов а-ля polkit. Всё, что нужно, уже есть – пользователь в группе, и юниксовые права для группы на устройство.<br /><br />Устройства, оставшиеся в группе disk – те самые, которые были опознаны и поименованы первым правилом udev, считаются системными, а потому не отображаются и не монтируются. Даже если они не прописаны в fstab <em>(а монтируются, скажем, через autofs)</em>, они всё равно не будут засорять список, в отличии от некоторых ГУИ, привязанных к udisks/polkit, к которым в таких случаях приходится применять грязные хаки, чтобы избавиться от навязчивого отображения прямо на рабочем столе разделов винчестера, не прописанных в fstab. <br /><br />Все опции монтирования и прочие параметры берутся из конфига <strong>/etc/mnt.conf</strong> , который местами похож на fstab :<br /><pre><code>[pref]
#name	value
group	storage
doscp	866
#       dir,downer:	%u =USER, %i =UID, %g =GID
#dir	/run/media/%u
#mode	700
#owner	%u:root
dir	/media
#usb1	force

[fs]
#type     options                                      flags
*         nosuid,nodev,user
udf       mode=0644,dmode=0755,utf8,ro                  UG
iso9660   mode=0644,dmode=0755,utf8,ro,overriderockperm UG
vfat      discard,shortname=mixed,utf8,codepage=866,fmask=0133,dmask=0022 UG
hfsplus   umask=0022                                    UG
hfs       file_umask=0133,dir_umask=0022                UG
btrfs     ssd
ext4      discard
ext3      
ext2      
reiserfs
nilfs2    discard
f2fs      discard
xfs       discard
jfs       iocharset=utf8,discard
ntfs      nls=utf8,fmask=0133,dmask=0022                UG

[blacklist]
#fs	label

[cd]
device	/dev/sr0
mount	cdrom
timeout	30</code></pre>В строке со звёздочкой* прописаны общие опции монтирования, а дальше опции для каждой ФС отдельно. Флажки U и G означают, что ФС будет монтироваться с указанием UID и GID пользователя.<br /><br />Параметр doscp задает DOS-кодировку для чтения для меток FAT, которые иногда бывают написаны русскими буквами. В ГУИ, привязанных к udisks, таких меток не видно.<br /><br />Кроме всего прочего, обнаруживается подключение флешки по USB-1. Поскольку такое подключение очень медленное, и чаще всего происходит из-за плохого контакта или неисправности, об этом выводится сообщение, и по-умолчанию такие устройства НЕ монтируются, если обратное не задано в конфиге или ключом -f<br />Если кто помнит, Windows XP в таких случаях тоже ругалась, чем-то вроде &quot;это устройство может работать быстрее...&quot;. Тогда я валил всё на &quot;форточные глюки&quot;, но потом выяснил причину, проникся, и вот, реализовал эту полезную фичу :)<br /><br /><strong>2.1. Монтирование: как это выглядит.</strong><br /><br />Вставляю флешку, и набираю в консоли команду <strong>mnt</strong> <pre><code>$ mnt
Файловая система Тип  Размер Использовано  Дост Использовано% Cмонтировано в
/dev/sdb1        f2fs   3.7G         2.2G  1.5G           61% /media/sdb1_k4f2</code></pre> Флешка смонтирована.<br /><br />Когда будет надо отмонтировать, я наберу команду <strong>umt</strong><pre><code>$ umt
/dev/sdb1       3.7G    f2fs    k4f2</code></pre> Флешка отмонтирована.<br /><br />Теперь я вставлю сразу три флешки, и наберу команду <strong>mls</strong><pre><code>$ mls
/dev/sdb   3.7G                    
/dev/sdb1  3.7G    f2fs  k4f2      
/dev/sdc   7.5G                    
/dev/sdc1  7G      vfat  K100N     
/dev/sdc2  526.5M  f2fs  Kf2       
/dev/sdd   1.8G                    
/dev/sdd1  1.8G    ext2  test64    </code></pre> и увижу список того, что вставлено.<br /><br />Я могу смонтировать всё, что есть: <pre><code>$ mnt
Файловая система Тип  Размер Использовано  Дост Использовано% Cмонтировано в
/dev/sdb1        f2fs   3.7G         2.2G  1.5G           61% /media/sdb1_k4f2
/dev/sdc1        vfat   7.0G         5.5G  1.5G           79% /media/sdc1_K100N
/dev/sdc2        f2fs   526M         117M  396M           23% /media/sdc2_Kf2
/dev/sdd1        ext2   1.8G         748M  980M           44% /media/sdd1_test64</code></pre>Могу отмонтировать и монтировать по одной больше: <pre><code>$ umt sdd1
/dev/sdd1       1.8G    ext2    test64
$ umt sdc1 sdc2
/dev/sdc1       7G      vfat    K100N
/dev/sdc2       526.5M  f2fs    Kf2
$ mnt sdc1
Файловая система Тип  Размер Использовано  Дост Использовано% Cмонтировано в
/dev/sdc1        vfat   7.0G         5.5G  1.5G           79% /media/sdc1_K100N</code></pre> могу посмотреть, что смонтировано: <pre><code>$ mls
/dev/sdb   3.7G                                     
/dev/sdb1  3.7G    f2fs  k4f2    /media/sdb1_k4f2   
/dev/sdc   7.5G                                     
/dev/sdc1  7G      vfat  K100N   /media/sdc1_K100N  
/dev/sdc2  526.5M  f2fs  Kf2                        
/dev/sdd   1.8G                                     
/dev/sdd1  1.8G    ext2  test64                     </code></pre> и отмонтировать всё, что осталось:<pre><code>$ umt
/dev/sdb1       3.7G    f2fs    k4f2
/dev/sdc1       7G      vfat    K100N</code></pre><br />Как видите, выглядит всё просто :)<br />Имя для точки монтирования автоматически составляется из порядкового имени диска и метки, чтобы сразу можно было отличить флешки и по порядку подключения, и по метке.<br /><br /><strong>2.3. Монтирование: как я это сделал.</strong><br /><br />Команды <strong>mnt</strong>, <strong>umt</strong> и <strong>mls</strong> – это один скрипт и два симлинка на него же, всё лежит в /usr/local/bin/<br /><br /><pre><code>#!/bin/bash

#config defaults
GROUP=storage
CP=866
BLST=

declare -A m_label m_type m_size m_mount m_usb

get_list() {
 DEVLIST=`find -L /dev/block/ -group $GROUP -exec readlink -f {} \; | sort`
 [[ -z &quot;$DEVLIST&quot; ]] &amp;&amp; return 0

 P=
 while read -r DEV SIZE TYPE LABEL
 do
  if [[ -n &quot;$P&quot; &amp;&amp; $DEV == $P* ]] ; then
   [[ -n &quot;${m_type[$P]}&quot; ]] &amp;&amp; unset m_type[$P] m_label[$P]
  else P=&quot;$DEV&quot;
  fi
  if [[ -z &quot;${m_usb[$P]}&quot; ]] ; then
   A=`readlink -f &quot;/sys/class/block/$P&quot; 2&gt; /dev/null`
   B=&quot;${A##*/usb}&quot;
   C=&quot;${B#*/}&quot;
   F=&quot;${A%$C}version&quot;
   [[ -f &quot;$F&quot; ]] &amp;&amp; read m_usb[$P] &lt; &quot;$F&quot; || m_usb[$P]=none
  else
   m_usb[$DEV]=&quot;${m_usb[$P]}&quot;
  fi
  m_size[$DEV]=&quot;$SIZE&quot;
  m_type[$DEV]=&quot;$TYPE&quot;
  printf -v m_label[$DEV] &#39;%b&#39; &quot;$LABEL&quot;
 done &lt; &lt;( lsblk -dnro NAME,SIZE,FSTYPE,LABEL $DEVLIST 2&gt;/dev/null )

 while read -ra LIN
 do
  DEV=&quot;${LIN[0]##*/}&quot;
  [[ -n $DEV &amp;&amp; -n ${LIN[1]} ]] &amp;&amp; printf -v m_mount[&quot;$DEV&quot;] &#39;%b&#39; &quot;${LIN[1]}&quot;
 done &lt; /proc/self/mounts
}

getid() {
 DEV=&quot;${1##*/}&quot;
 TYPE=&quot;${m_type[$DEV]}&quot;
 LABEL=&quot;${m_label[$DEV]}&quot;
 case &quot;$TYPE&quot; in
 dos|fat|vfat)
  LABEL=`echo -n &quot;$LABEL&quot; | iconv -f $CP`
  ;;
 esac
 SIZE=&quot;${m_size[$DEV]}&quot;
 MOUNT=&quot;${m_mount[$DEV]}&quot;
 USB=&quot;${m_usb[$DEV]}&quot;
 [[ $USB =~ ^1\. ]] &amp;&amp; USB=&#39;***USB-1***&#39; || USB=
}

for_dev() {
 get_list
 for FILE in $DEVLIST; do
  getid $FILE
  &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a286e2">[email&#160;protected]</a>&quot;
 done
}

dfN() {
C=&quot;df -hT $1&quot;
if [[ -z $fN ]] ; then
 $C
 fN=1
else
 $C | tail -n 1
fi
}

gen_clabel() {
 CLABEL=$(echo -n &quot;$LABEL&quot;|tr &#39;[:cntrl:]&#39; &#39;?&#39;)
}

mnt_dev() {
 [[ -n &quot;$1&quot; &amp;&amp; &quot;$TYPE $LABEL&quot; =~ $1 ]] &amp;&amp; return 1
 [[ &quot;$TYPE&quot; = &#39;swap&#39; ]] &amp;&amp; return 1
 if [[ $CMD == &#39;mnt&#39; ]] ; then
  if [[ -n $TYPE &amp;&amp; -z $MOUNT ]] ; then
   if [[ -n &quot;$USB&quot; &amp;&amp; -z &quot;$FORCE&quot; ]] ; then
    list_dev
    return 1
   fi
   if [[ -n &quot;$LABEL&quot; ]] ; then
    L=$(echo -n &quot;$LABEL&quot;|tr -s &#39;[:cntrl:][:blank:]\!&quot;$&amp;\47()*/;&lt;&gt;?\[\\\]`{|}&#39; _)
    M=&quot;$DEV&quot;_&quot;$L&quot;
   else M=&quot;$DEV&quot;
   fi
   smount &quot;$FILE&quot; &quot;$M&quot; &amp;&amp; dfN &quot;$FILE&quot;
  fi
 else
  if [[ -n $MOUNT ]] ; then
   gen_clabel
   usmount &quot;$FILE&quot; &amp;&amp; echo $FILE$&#39;\t&#39;$SIZE$&#39;\t&#39;$TYPE$&#39;\t&#39;&quot;$CLABEL&quot;
  fi
 fi
}

list_dev() {
 if [[ -n $TYPE &amp;&amp; -z &quot;$LABEL&quot; ]] ; then
  LABEL=&#39;\no label/&#39;
 fi
 gen_clabel
 echo $FILE$&#39;\t&#39;$SIZE$&#39;\t&#39;$TYPE$&#39;\t&#39;&quot;$CLABEL&quot;$&#39;\t&#39;$MOUNT$&#39;\t&#39;$USB
}

sw=
while read -a C ; do
 c=&quot;${C[0]}&quot;
 case &quot;$c&quot; in
 \[pref\])
  sw=pref
  ;;
 \[blacklist\])
  sw=blacklist
  ;;
 \[*)
  sw=
  ;;
 \#*|&#39;&#39;)
  ;;
 *)
  case &quot;$sw&quot; in
  pref)
   o=&quot;${C[*]:1:2}&quot;
   case &quot;$c&quot; in
   group)
    GROUP=&quot;$o&quot;
    ;;
   doscp)
    CP=&quot;$o&quot;
    ;;
   usb1)
    [[ &quot;$o&quot; = &#39;force&#39; ]] &amp;&amp; FORCE=1
    ;;
   esac
   ;;
  blacklist)
   BLST=&quot;$BLST$c ${C[*]:1:2}|&quot;
   ;;
  *)
   ;;
  esac
  ;;
 esac
done &lt; /etc/mnt.conf

CMD=&quot;${0##*/}&quot;
case &quot;$1&quot; in
&#39;-u&#39;) CMD=umt
 shift
 ;;
&#39;-l&#39;) CMD=mls
 shift
 ;;
&#39;-f&#39;) FORCE=1
 shift
 ;;
esac
case &quot;$CMD&quot; in
 &#39;mnt&#39;|&#39;umt&#39;)
if [[ -z $1 ]] ; then
 if [[ -n &quot;$BLST&quot; ]] ; then
  b=&quot;${BLST//./\\.}&quot;; b=&quot;${b//\*/.*}&quot;; b=&quot;${b//\?/.}&quot;
  BLST=&quot;^(${b%|})$&quot;
 fi
 for_dev mnt_dev &quot;$BLST&quot;
else
 get_list
 while [[ -n $1 ]] ; do
  [[ &quot;$1&quot; = /* ]] &amp;&amp; FILE=&quot;$1&quot; || FILE=&quot;/dev/$1&quot;
  getid &quot;$FILE&quot;
  mnt_dev
  shift
 done
fi
;;
 &#39;mls&#39;)
for_dev list_dev | column -t -s $&#39;\t&#39;
;;
esac</code></pre>Скрипт работает под пользователем. Непосредственно для операции монтирования раньше из этого скрипта вызывался <strong>pmount</strong>, но потом он перестал меня устраивать из-за излишней хардкодности и древности – он не знал некоторых новых ФС и поддерживал не все нужные мне опции.<br /><br />В результате я написал вместо pmount ещё один скрипт, который имеет нормальный (НЕ хардкодный) конфиг и сам перезапускается под рутом через sudo. Скрипт называется <strong>smount</strong>, и на него ссылаются ещё два симлинка: <strong>usmount</strong> и <strong>/usr/bin/umount.smount</strong> – последний нужен для отмонтирования под пользователем из сторонних программ, таких как eject, благодаря параметру uhelper=smount.<br /><pre><code>#!/bin/bash

#config defaults
MDIR=/media
DMODE=755
DOWNER=

HL1=&quot;helper=smount&quot;
HL2=&quot;u$HL1&quot;

NAME=&quot;${0##*/}&quot;

[[ &quot;$NAME&quot; = &quot;umount.smount&quot; ]] &amp;&amp; NAME=&#39;usmount&#39;

uid=`id -u`
if ((uid&gt;0))
then
 FILE=`readlink -f $0`
 DIR=&quot;${FILE%/*}&quot;
 exec sudo $DIR/$NAME &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="012541">[email&#160;protected]</a>&quot;
fi

err() {
 echo &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8da9cd">[email&#160;protected]</a>&quot; &gt;&amp;2
 exit 1
}

addopt() {
 [[ -n &quot;$O&quot; &amp;&amp; -n &quot;$1&quot; ]] &amp;&amp; d=&#39;,&#39; || d=
 O=&quot;$O$d$1&quot;
}

ugparse() {
 if [[ &quot;$o&quot; =~ %(u|i|g) ]] ; then
  [[ -n &quot;$SUDO_USER&quot; ]] &amp;&amp; u=&quot;$SUDO_USER&quot; || u=root
  o=&quot;${o//%u/$u}&quot;
  [[ -n &quot;$SUDO_UID&quot; ]] &amp;&amp; id=&quot;$SUDO_UID&quot; || id=0
  o=&quot;${o//%i/$id}&quot;
  [[ -n &quot;$SUDO_GID&quot; ]] &amp;&amp; g=&quot;$SUDO_GID&quot; || g=0
  o=&quot;${o//%g/$g}&quot;
 fi
}

RO=
i=1
for p in &quot;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d0f490">[email&#160;protected]</a>&quot;; do
 case &quot;$p&quot; in
 -r|--read-only)
  RO=1
  ;;
 -*)
  ;;
 *)
  par[$i]=&quot;$p&quot;
  ((i++))
  ;;
 esac
done

declare -A OPT FLAG

sw=
while read -a C ; do
 c=&quot;${C[0]}&quot;
 case &quot;$c&quot; in
 \[fs\]|\[FS\])
  sw=fs
  ;;
 \[pref\]|\[PREF\])
  sw=pref
  ;;
 \[*)
  sw=
  ;;
 \#*|&#39;&#39;)
  ;;
 *)
  case &quot;$sw&quot; in
  fs)
   [[ &quot;$c&quot; = &#39;*&#39; ]] &amp;&amp; c=default
   o=&quot;${C[1]}&quot;
   [[ &quot;$o&quot; =~ ^\# ]] &amp;&amp; continue
   [[ &quot;$o&quot; = &#39;*&#39; ]] &amp;&amp; o=
   OPT[&quot;$c&quot;]=&quot;$o&quot;
   o=&quot;${C[2]}&quot;
   f=0
   [[ &quot;$o&quot; =~ ^\# ]] &amp;&amp; continue
   [[ &quot;$o&quot; =~ [uU] ]] &amp;&amp; f=1
   [[ &quot;$o&quot; =~ [gG] ]] &amp;&amp; ((f|=2))
   FLAG[&quot;$c&quot;]=&quot;$f&quot;
   ;;
  pref)
   o=&quot;${C[1]}&quot;
   [[ &quot;$o&quot; =~ ^\# ]] &amp;&amp; o=
   case &quot;$c&quot; in
   dir)
    if [[ -n &quot;$o&quot; ]] ; then
     ugparse
     MDIR=&quot;$o&quot;
    fi
    ;;
   mode)
    [[ -n &quot;$o&quot; ]] &amp;&amp; DMODE=&quot;$o&quot;
    ;;
   owner)
    if [[ -n &quot;$o&quot; ]] ; then
     ugparse
     DOWNER=&quot;$o&quot;
    fi
    ;;
   esac
   ;;
  *)
   ;;
  esac
  ;;
 esac
done &lt; /etc/mnt.conf

case &quot;$NAME&quot; in
smount)
 DEV=&quot;${par[1]}&quot;
 MNT=&quot;${par[2]}&quot;
 [[ -z &quot;$MNT&quot; ]] &amp;&amp; err &quot;No selected mountpoint&quot;
 MNT=&quot;$MDIR&quot;/$(echo -n &quot;$MNT&quot;|tr -s &#39;[:cntrl:][:blank:]\!&quot;$&amp;\47()*/;&lt;&gt;?\[\\\]`{|}&#39; _)
 grep -qF &quot; $MNT &quot; /proc/mounts &amp;&amp; err &quot;$MNT already mounted&quot;
 ;;
usmount)
 DEV=
 MNT=
 P=&quot;${par[1]}&quot;
 [[ -z &quot;$P&quot; ]] &amp;&amp; err &quot;No argument&quot;
 if [[ -d &quot;$P&quot; ]] ; then
  MNT=&quot;$P&quot;
  L=`grep -F &quot; $MNT &quot; /proc/mounts`
  DEV=&quot;${L%% *}&quot;
 else
  DEV=&quot;$P&quot;
 fi
 ;;
*)
 err &quot;Unknown command &#39;$NAME&#39;&quot;
 ;;
esac

read DEV &lt; &lt;(readlink -f &quot;$DEV&quot;)
[[ -b &quot;$DEV&quot; ]] || err &quot;No usable source&quot;
if [[ -n &quot;$SUDO_USER&quot; ]] ; then
 sudo -u &quot;$SUDO_USER&quot; [ -r &quot;$DEV&quot; ] || err &quot;No access to source&quot;
 sudo -u &quot;$SUDO_USER&quot; [ -w &quot;$DEV&quot; ] || RO=1
fi

case &quot;$NAME&quot; in
smount)
 R=
 [[ -n &quot;$RO&quot; ]] &amp;&amp; R=&#39;-r&#39;

 TYPE=`lsblk -dnro FSTYPE &quot;$DEV&quot; 2&gt;&amp;-`
 [[ -z &quot;$TYPE&quot; ]] &amp;&amp; err &quot;Unknown FS type&quot;

 O=${OPT[default]}
 addopt ${OPT[&quot;$TYPE&quot;]}

 Fd=${FLAG[default]}
 F=${FLAG[&quot;$TYPE&quot;]}
 ((F|=Fd))

 if [[ -n &quot;$SUDO_UID&quot; ]] ; then
  ((F&amp;1)) &amp;&amp; addopt &quot;uid=$SUDO_UID&quot;
  ((F&amp;2)) &amp;&amp; addopt &quot;gid=$SUDO_GID&quot;
 fi

 [[ -z &quot;$O&quot; ]] &amp;&amp; O=defaults

 if [[ ! -d &quot;$MDIR&quot; ]] ; then
  mkdir -m &quot;$DMODE&quot; -p &quot;$MDIR&quot; || err &quot;Can&#39;t create $MDIR&quot;
  chown &quot;$DOWNER&quot; &quot;$MDIR&quot;  || err &quot;Can&#39;t change owner of $MDIR to $DOWNER&quot;
 fi
 mkdir -p &quot;$MNT&quot; || err &quot;Can&#39;t create $MNT&quot;
 mount $R -o &quot;$O,$HL1,$HL2&quot; &quot;$DEV&quot; &quot;$MNT&quot; || rmdir &quot;$MNT&quot;
 ;;
usmount)
 if [[ -z &quot;$MNT&quot; ]] ; then
  L=`grep -F &quot;$DEV &quot; /proc/mounts`
  L=&quot;${L#* }&quot;
  MNT=&quot;${L%% *}&quot;
 fi
 [[ -n &quot;$MNT&quot; &amp;&amp; -d &quot;$MNT&quot; ]] || err &quot;Mountpoint not found&quot;
 [[ &quot;$MNT&quot; =~ ^&quot;$MDIR&quot;/.*$ ]] &amp;&amp; F=1 || F=0
 if [[ -n &quot;$SUDO_USER&quot; ]] || ((F==1)) ; then
  ((F==0)) &amp;&amp; err &quot;$MNT not in $MDIR&quot;
  umount -i &quot;$MNT&quot; &amp;&amp; rmdir &quot;$MNT&quot;
 else
  UTAB=/run/mount/utab
  [[ -f &quot;$UTAB&quot; ]] &amp;&amp; while read line; do
   l=&quot; $line &quot;
   o=&quot;${l##* OPTS=}&quot;; o=&quot;,${o%% *},&quot;
   if [[ $l = *\ SRC=&quot;$DEV&quot;\ * &amp;&amp; $l = *\ TARGET=&quot;$MNT&quot;\ * &amp;&amp; $o = *,$HL1,* ]] ; then
    F=1
    break
   fi
  done &lt; &quot;$UTAB&quot;
  umount -i &quot;$MNT&quot; || exit 1
  ((F==0)) || rmdir &quot;$MNT&quot;
 fi
 ;;
esac</code></pre>Запись в <strong>/etc/sudoers</strong> : <pre><code>%users hostname=NOPASSWD:/usr/local/bin/smount *,/usr/local/bin/usmount *</code></pre> где hostname это имя хоста.<br /><br />Кроме группы storage, обычно присутствует ещё одно специфическое устройство, которое в неё не входит – это CD/DVD дисковод. О монтировании сидишников я расскажу в следующей части.<br /><br /><em>Продолжение:</em><br /><a href="https://archlinux.org.ru/forum/topic/12712/"><u>Часть 3: укрощение сидишника и немного GUI.</u></a>
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124208"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/RAMZAY/">
                <span class="post-username">RAMZAY</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124208/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/00/cf/00cf8778fdfc123989b84be78849fb61.png" alt="RAMZAY avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/RAMZAY/topics/">
                    43
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/RAMZAY/posts/">
                    448
                </a>
            </div>
            <div>
                Участник с: 21 мая 2011
            </div>
            
        </td>
        <td class="post-content">
            Будем реализовывать,честно говоря пока что вручную монтирую устройства что подключаю,<strong>lsusb</strong> и <strong>lsblk</strong> очень хорошие вещи,разделы на вениках монтирую через самописный банальный скрипт с mount /dev/sd** /media/name* (лень было каждый раз писать mount) Не нравится мне дефолтное монтирование в /run/media/name_of_user/name_volume (или как там).<br/>Хорошим ты делом занялся,спасибо,посмотрим что же еще можно натворить будет.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124252"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/Natrio/">
                <span class="post-username">Natrio</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124252/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/Natrio/topics/">
                    47
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/Natrio/posts/">
                    4763
                </a>
            </div>
            <div>
                Участник с: 08 января 2011
            </div>
            
        </td>
        <td class="post-content">
            Спасибо на добром слове :)<br/><br/>А <strong>lsblk</strong> действительно хорошая утилита, её гораздо удобнее использовать в скриптах, чем <strong>blkid</strong> и некоторые другие.<br/><br/>Что касается разделов "на вениках", то когда я гружу левый комп со своей флешки, "системным диском" считается именно она, а собственные винчестеры этой машины успешно попадают в группу storage, и монтируются так же, как и флешки.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124256"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/farwayer/">
                <span class="post-username">farwayer</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124256/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/16/f5/16f5cbfb000c892f9ee33b90af9e06e0.png" alt="farwayer avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/farwayer/topics/">
                    12
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/farwayer/posts/">
                    181
                </a>
            </div>
            <div>
                Участник с: 30 апреля 2010
            </div>
            
        </td>
        <td class="post-content">
            Спасибо за статью и отдельно за lsblk :)<br/>Чем-то напоминает mnttools ( <a href="https://aur.archlinux.org/packages/mnttools/">https://aur.archlinux.org/packages/mnttools/</a> ), только добавлены настройки мотирования по типу ФС.<br/>А разве без sudo работать не будет, если пользователь состоит в группе storage?<br/>Кстати, /media больше нету. Теперь предлагают все монтировать в /mnt.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124257"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/RAMZAY/">
                <span class="post-username">RAMZAY</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124257/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/00/cf/00cf8778fdfc123989b84be78849fb61.png" alt="RAMZAY avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/RAMZAY/topics/">
                    43
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/RAMZAY/posts/">
                    448
                </a>
            </div>
            <div>
                Участник с: 21 мая 2011
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>Natrio</em><br/>Спасибо на добром слове :)<br/><br/>А <strong>lsblk</strong> действительно хорошая утилита, её гораздо удобнее использовать в скриптах, чем <strong>blkid</strong> и некоторые другие.<br/><br/>Что касается разделов "на вениках", то когда я гружу левый комп со своей флешки, "системным диском" считается именно она, а собственные винчестеры этой машины успешно попадают в группу storage, и монтируются так же, как и флешки.</blockquote>Я свой арч на флехе привязал по UUID'у в fstab'е (ИМХО единственное место где UUID полезен). Надо будет там реализовать ваш метод, ибо каждый раз ручками монтировать диски машин куда я подключаюсь уже поднадоело =)
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124274"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/Natrio/">
                <span class="post-username">Natrio</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124274/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/Natrio/topics/">
                    47
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/Natrio/posts/">
                    4763
                </a>
            </div>
            <div>
                Участник с: 08 января 2011
            </div>
            
        </td>
        <td class="post-content">
            <blockquote><em>farwayer</em><br/>Кстати, /media больше нету. Теперь предлагают все монтировать в /mnt.</blockquote>Если /media/ нету, ничто не мешает его создать.<br/>А в /mnt/ у меня статические точки монтирования.<br/><br/><blockquote>А разве без sudo работать не будет, если пользователь состоит в группе storage?</blockquote>Не будет, разве что только FUSE и только в принадлежащий пользователю каталог.<br/>Во всех остальных случаях для монтирования нужны права рута, которые обычно получаются через бит SUID на бинарнике, а в скриптах на баше я обычно использую самоперезапуск через sudo.<br/><br/><blockquote><em>RAMZAY</em><br/>Я свой арч на флехе привязал по UUID'у в fstab'е (ИМХО единственное место где UUID полезен). Надо будет там реализовать ваш метод, ибо каждый раз ручками монтировать диски машин куда я подключаюсь уже поднадоело =)</blockquote>UUID полезен для автоматических установщиков, а так же тем, что сохраняется при клонировании раздела.<br/>Его минусы – лишь обратная сторона его плюсов: что удобно для роботов, неудобно для людей; а привязка к разделу не даёт простого способа отделить в udev весь диск целиком.
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-124294"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/Natrio/">
                <span class="post-username">Natrio</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/124294/">#</a>
            8 лет, 9 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/Natrio/topics/">
                    47
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/Natrio/posts/">
                    4763
                </a>
            </div>
            <div>
                Участник с: 08 января 2011
            </div>
            
        </td>
        <td class="post-content">
            Продолжение:<br/><a href="https://archlinux.org.ru/forum/topic/12712/"><u>Часть 3: укрощение сидишника и немного GUI.</u></a>
            
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
                
                




<table class="table table-bordered post post-row
       "
       id="post-125813"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/antiron/">
                <span class="post-username">antiron</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/125813/">#</a>
            8 лет, 8 месяцев назад
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
        <img src="https://storage.yandexcloud.net/aor-static/media/cache/ac/18/ac18c1c36c0116e2d94cd49388ce29a4.png" alt="antiron avatar" />
    
</div>

            <div>
                Темы:
                <a href="/forum/users/antiron/topics/">
                    32
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/antiron/posts/">
                    270
                </a>
            </div>
            <div>
                Участник с: 29 августа 2013
            </div>
            
        </td>
        <td class="post-content">
            <strong>Natrio</strong>, огромное спасибо,очень клевая задумка,всё,теперь никаких mount,только mnt и umt))
            
                
                    <div class="post-signature">
                        Non progredi - est regredi
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="/accounts/register/">Зарегистрироваться</a> или <a href="/accounts/login/?next=/forum/topic/12702/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){var js = "window['__CF$cv$params']={r:'747ab563f8807b1f',m:'GkmEn6uUncC77FN8xg7UT4rqIBLoBtoT9riJVEW8bAk-1662671823-0-AXbpK6Fsgz7/UlalfrYwVMaDFsFlduI+7D5IGRXcjyxmpNmb0t/eIf/KyNCgUjcQnv7l8RPaknr9dV9hBRGYrobou+QCBwuHZwBlKTdu6xgfne7tjf/KrarcJ2eY+INAlUFsB391VdEmeAr5y74NPIo=',s:[0xe8f6b3f2a0,0x431060cc3c],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='/cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
</html>
