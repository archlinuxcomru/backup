


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Немного о ручном восстановлении файлов (на примере jpg)
    </title>
    <link rel="shortcut icon" href="https://storage.yandexcloud.net/aor-static/static/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="https://storage.yandexcloud.net/aor-static/static/css/default.css">
    
    
    

    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/pybbjs.js"></script>
    
    
    
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/posts/" title="Последние сообщения на форуме" >
    <link rel="alternate" type="application/atom+xml" href="/forum/feeds/topics/" title="Последние темы на форуме" >

    
    
    
    <script type="text/javascript" src="https://storage.yandexcloud.net/aor-static/static/pybb/js/jquery.formset.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid wrapper">
        
    
<ul class="nav navbar-nav">
    <li>
      <a class="navbar-brand" href="/">
        <img src="https://storage.yandexcloud.net/aor-static/static/logo.png" alt="" style="opacity: .7; vertical-align: top">
      </a>
    </li>
    <li class=""><a href="/news/">Новости</a></li>
    <li class="active"><a href="/forum/">Форум</a></li>
    <li class=""><a href="/blogs/">Блоги</a></li>
    <li><a href="https://archlinux.org/">Eng</a></li>
    <li><a href="https://wiki.archlinux.org/index.php/Main_page_%28%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9%29">Wiki</a></li>
    <li class="dropdown">
      <a href="https://www.archlinux.org/packages/" class="dropdown-toggle" data-toggle="dropdown">
        Пакеты
        <b class="caret"></b>
      </a>
      <ul class="dropdown-menu">
        <li><a href="https://www.archlinux.org/packages/">Официальные репозитории</a></li></li>
        <li><a href="https://aur.archlinux.org/?setlang=ru">AUR</a></li>
      </ul>
    <li><a href="https://archlinux.org/download/">Скачать</a></li>
</ul>

<form class="navbar-form navbar-left" role="search" action="https://www.google.ru/cse">
    <input type="hidden" name="cx" value="018428664132160064944:ntsma9ch2ug"/>
    <input type="hidden" name="ie" value="UTF-8"/>
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Что ищем?">
      <span class="input-group-btn">
        <button type="submit" name="sa" class="btn btn-default">Найти</button>
      </span>
    </div>
</form>

<ul class="nav navbar-nav navbar-right">


    
      <li><a href="/irc/#chat">IRC</a></li>
      <li class="dropdown">
        <a href="/accounts/login/" class="dropdown-toggle" data-toggle="dropdown">
          Профиль
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
          <li><a href="/accounts/login/">Вход</a></li>
          <li><a href="/accounts/register/">Регистрация</a></li>
        </ul>
      </li>
    
</ul>


    </div>
</nav>



<div class="modal fade" id='new_pm_notify' role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content navbar-default">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridSystemModalLabel">Новые личные сообщения</h4>
      </div>
      <div class="modal-body">
        <a href="/messages/inbox/" class="center-block btn btn-primary">Перейти в папку Входящие <span class="badge"></span></a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid wrapper">
    <div class="row">
        <div class="col-md-12">
            
    
        
<ul class="breadcrumb">
    

    <li><a href="/">ArchLinux.org.ru</a></li>


    <li><a href="/forum/">Начало</a> <span class="divider">/</span></li>
    
        
            
                <li><a href="/forum/category/8/">Блоги</a> <span class="divider">/</span></li>
            
                <li><a href="/forum/forum/25/">Блоги</a> <span class="divider">/</span></li>
            
        
        
            <li>Немного о ручном восстановлении файлов (на примере jpg)</li>
        
    
    
</ul>

    

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            
    <div class="row">
        <div class="col-md-12 forum">
            
    
    <div class="topic">
        <h1>Немного о ручном восстановлении файлов (на примере jpg)</h1>
        
            <div class="text-center">
    



</div>

        

        

        <div class="posts">
            
            
                
                




<table class="table table-bordered post post-row
       "
       id="post-215331"
       >
    <thead>
    <tr>
        <td class="post-author">
            <a href="/forum/users/vasek/">
                <span class="post-username">vasek</span>
            </a>
        </td>
        <td class="post-date">
            <div class="post-control">
                
                    
                
            </div>
            <a class="permalink" href="/forum/post/215331/">#</a>
            3 года, 6 месяцев назад
            
                (отредактировано
                
                    3 года, 6 месяцев назад)
                
            
            
        </td>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td class="post-info">
            

<div class="avatar">
    
</div>

            <div>
                Темы:
                <a href="/forum/users/vasek/topics/">
                    48
                </a>
            </div>
            <div>
                Сообщения:
                <a href="/forum/users/vasek/posts/">
                    11340
                </a>
            </div>
            <div>
                Участник с: 17 февраля 2013
            </div>
            
        </td>
        <td class="post-content">
            На днях приходили молодые «хакеры» во главе с самым младшим внуком и пытали меня в части восстановления файла jpg с нерабочей флешки - говорили, что файл очень ценный и он им нужен. Взял у них день передышки для поготовки. Подготовился, ликбез провел, притом в расширенном виде - упомянул им даже о стеганографии. Набросок остался, выкидывать жалко, а потому решил описать в блоге, может когда-нибудь и пригодится.<br /><br />Для восстановления файлов по сигнатуре непременным условием является хорошее знание структуры формата файла.<br />В качестве примера рассмотрим графический файл JPEG (файл с расширением jpg). Не буду описывать его формат, а просто привожу ссылку на хорошую <a href="http://vbzero.narod.ru/articles/article_4.htm">статью</a>, в которой все подробно описано. В принципе достаточно знание и одной сигнатуры файла (начальная последовательность байт, однозначно идентифицирующая определенный тип файлов).<br />Для файлов jpg такой последовательностью являются два байта <strong>FF D8</strong>, но обычно во всех базах и справочниках за сигнатуру файлов  jpg принимают 4 байта - <strong>FF D8 FF E0</strong>. И как видим из описания формата jpg, конец файла завершается двумя байтами <strong>FF D9</strong><br /><br />Для поиска лучше разделить образ/дамп (раздела, флэшки и др.) на части, например, по 5 Гигов или меньше или больше или вообще не делить - все зависит от размера образа/дампа и быстродействия компа.<br />Можно, конечно, использовать для поиска hexeditor, но там есть свои нюансы. Лучше использовать чисто ручной поиск.<br />И так приступим. В качестве подопытного выбрал файл-образ учебной системы с btrfs размером 1G (~/btrfs-image), в котором хранится три типа файлов: jpg, odt, txt.<br />Как уже писал, выбран файл jpg, имеющий сигнатуру  <strong>FF D8 FF E0</strong>, вот ее и будем искать, используя утилиту <strong>od</strong>.<br /><strong>Важно</strong> - сигнатуру прописывать маленькими буквами, отделяя каждый байт пробелом.<br /><br /><strong>od -A d -t x1 ~/btrfs-image | grep &quot;ff d8 ff e0&quot;</strong><br />13660160 <strong>ff d8 ff e0</strong> 00 10 4a 46 49 46 00 01 01 01 00 60<br /><br /><strong>13660160</strong> - это смещение (номер байта в 10-ом исчислении), начиная с которого в ~/btrfs-image начинается расположение нужного нам файла. Проверим, что мы нашли, но уже используя утилиту hexdump<br /><strong>hexdump -C -s 13660160 -n 16 ~/btrfs-image</strong><br />00d07000  <strong>ff d8 ff e0</strong> 00 10 4a 46  49 46 00 01 01 01 00 60  |......<strong>JFIF</strong>.....`|<br />и видим, что это точно jpg - видим наличие  JFIF<br /><br />Ищем конец файла, но начинаем искать со смешением 13660160<br /><strong>od -A d -t x1 -j 13660160 ~/btrfs-image | grep &quot;ff d9&quot;</strong><br />13858368 50 6c 03 b9 fc e8 a2 b3 70 8f 63 5b b3 <strong>ff d9</strong> 00<br />Определяем, что файл заканчивается на байте <strong>13858383</strong>, проверяем hexdump, но <u>пропустим 13858382 байта</u> (<strong>на 1 байт меньше</strong> и первым байтом должно быть d9)<br /><strong>hexdump -C -s 13858382 -n 16 ~/btrfs-image</strong><br />00d3764e  <strong>d9</strong> 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br />Все верно, а дальше идут нули.<br />Вытаскиваем этот файл с помощью dd - скопируем из файла ~/btrfs-image 198223 байт (13858383 - 13660160), пропустив 13660160 байт<br /><strong>dd if=~/btrfs-image of=~/test.jpg skip=13660160 bs=1 count=198223</strong><br />Открываем файл test.jpg и убеждаемся, что все нормально.<br /><br /><strong>Нюансы</strong><br />1.  Если файлов с искомой сигнатурой много, то будут проблемы - так как ищем в слепую, то мы не знаем какой файл нашли, ориентироваться можем только на размер.  Если нужен конкретный файл, то нужна дополнительная информация, но это уже другая тема … плюс навык, который приходит с опытом.<br /><br />2. При использовании для поиска утилиты od возможны нюансы - не находится нужная искомая комбинация, это может говорить о том, что либо такая комбинация отсутствует, либо она <u>расположена на разных строках</u>, типа такого<br /><br />13660144 d0 ee ff e0 00 10 4a 46 49 46 00 01 01 01 <strong>ff d8</strong><br />13660160 <strong>ff e0</strong> 12 45 10 4a 46 49 46 00 01 01 01 00 60 ff<br /><br />и значит нужно менять комбинацию поиска - это тоже приходит с опытом и пониманием того, что делается. Ну вот, как то так в кратце.<br /><br /><strong>PS</strong> - в графических файлах изображения есть как отрицательные моменты, так и положительные.<br /><strong>Отрицательные</strong> - как можно заметить из описания формата jpg (ссылка была дана в начале), если в извеченном файле попорчены определенные реперные байты, то изображение не откроется. Для востановления файлов желательно хорошо знать полную структуру формата файлов, что поможет провести анализ реперных байтов, найти несоответсвие параметров изображения (попорченные байты) и выполнить соответствующее редактирование.<br /><br /><strong>Положительные</strong> - байты, не являющиеся реперными, можно менять, удалять  и это не скажется на открытии изображение. Это частенько используют при защите паролей, небольших файлов - называется сей способ <strong>стеганография</strong> и есть даже специальные утилиты для этого. Но, имхо, применение любой утилиты связано тоже с сигнатуорй, которую накладывает данная утилита, а значит сам факт наличия чего то спрятанного в изображении можно установить. Кстати, даже есть такие антиутилиты, которые позволяют это делать. Один плюс -  вычислить это довольно сложно, да и редко кто сможет.<br />Лично я использую для этого чисто ручной способ. Хоть сейчас езжу редко, но раньше в поездках всегда брал с собой флешку, на которой находилось несколько (2-3) часто используемых паролей, не запоминаемых. Использовать всякие утилиты для шифрования не удобно, намного проще спрятать эти пароли в какой-нибудь картинке, в определенном месте,  hexeditor-ом посмотреть не проблема, а, главное, никогда не вычислишь любым способом.
            
                
                    <div class="post-signature">
                        Ошибки не исчезают с опытом - они просто умнеют
                    </div>
                
            

            <div class="post-related">
                <div class='attachments'>
                    
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

            
        </div>
        <div>&nbsp;</div>
        
            <div class="text-center">
    



</div>

        

        

        
            
<a href="/accounts/register/">Зарегистрироваться</a> или <a href="/accounts/login/?next=/forum/topic/19112/">войдите</a> чтобы оставить сообщение.

        

        
    </div>

        </div>
    </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6 footer">
            
                <p class="copyright">&copy; 2006-2022, Русскоязычное сообщество
                    Arch Linux.<br>Название и логотип Arch Linux &trade;
                    являются признанными торговыми
                    марками.<br>Linux &reg; &mdash; зарегистрированная торговая
                    марка Linus Torvalds и LMI.</p>
            
        </div>
    </div>
</div>

<script>(function(){var js = "window['__CF$cv$params']={r:'747ab2fa3b4d7a6d',m:'FYCkOERbLq_odgo.FAuclBgpvM5LoebV2KTjbhOXkx4-1662671723-0-ATdxtvo9BR0rSBxdrOWOjQRR+VWAmO37+lb++LyiluNeyzkfM0pe7Xj6QtEwOEDU2aigpp8Uwj/KcUqpBzMfz02fqz0vPE1bRascCP0MTIMOpYn1VYbSnu2UZb1ENesm/tZQG9zSxm5vPckTlfKHWG4=',s:[0xe3bb1ea2e4,0x87010e1997],u:'/cdn-cgi/challenge-platform/h/g'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='',_cpo.src='/cdn-cgi/challenge-platform/h/g/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = '';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body>
</html>
